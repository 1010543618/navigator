var map;!function(i){"use strict";var t='[data-dismiss="alert"]',a=function(e){i(e).on("click",t,this.close)};a.prototype.close=function(e){function t(){r.trigger("closed.bs.alert").remove()}var n=i(this),a=n.attr("data-target");a||(a=(a=n.attr("href"))&&a.replace(/.*(?=#[^\s]*$)/,""));var r=i(a);e&&e.preventDefault(),r.length||(r=n.hasClass("alert")?n:n.parent()),r.trigger(e=i.Event("close.bs.alert")),e.isDefaultPrevented()||(r.removeClass("in"),i.support.transition&&r.hasClass("fade")?r.one(i.support.transition.end,t).emulateTransitionEnd(150):t())};var e=i.fn.alert;i.fn.alert=function(n){return this.each(function(){var e=i(this),t=e.data("bs.alert");t||e.data("bs.alert",t=new a(this)),"string"==typeof n&&t[n].call(e)})},i.fn.alert.Constructor=a,i.fn.alert.noConflict=function(){return i.fn.alert=e,this},i(document).on("click.bs.alert.data-api",t,a.prototype.close)}(jQuery),function(o){function i(n){o(".dropdown-backdrop").remove(),o(c).each(function(){var e=l(o(this)),t={relatedTarget:this};e.hasClass("open")&&(e.trigger(n=o.Event("hide.bs.dropdown",t)),n.isDefaultPrevented()||e.removeClass("open").trigger("hidden.bs.dropdown",t))})}function l(e){var t=e.attr("data-target");t||(t=(t=e.attr("href"))&&/#[A-Za-z]/.test(t)&&t.replace(/.*(?=#[^\s]*$)/,""));var n=t&&o(t);return n&&n.length?n:e.parent()}var c="[data-toggle=dropdown]",a=function(e){o(e).on("click.bs.dropdown",this.toggle)};a.prototype.toggle=function(e){var t=o(this);if(!t.is(".disabled, :disabled")){var n=l(t),a=n.hasClass("open");if(i(),!a){"ontouchstart"in document.documentElement&&!n.closest(".navbar-nav").length&&o('<div class="dropdown-backdrop"/>').insertAfter(o(this)).on("click",i);var r={relatedTarget:this};if(n.trigger(e=o.Event("show.bs.dropdown",r)),e.isDefaultPrevented())return;n.toggleClass("open").trigger("shown.bs.dropdown",r),t.focus()}return!1}},a.prototype.keydown=function(e){if(/(38|40|27)/.test(e.keyCode)){var t=o(this);if(e.preventDefault(),e.stopPropagation(),!t.is(".disabled, :disabled")){var n=l(t),a=n.hasClass("open");if(!a||a&&27==e.keyCode)return 27==e.which&&n.find(c).focus(),t.click();var r=" li:not(.divider):visible a",i=n.find("[role=menu]"+r+", [role=listbox]"+r);if(i.length){var s=i.index(i.filter(":focus"));38==e.keyCode&&0<s&&s--,40==e.keyCode&&s<i.length-1&&s++,~s||(s=0),i.eq(s).focus()}}}};var e=o.fn.dropdown;o.fn.dropdown=function(n){return this.each(function(){var e=o(this),t=e.data("bs.dropdown");t||e.data("bs.dropdown",t=new a(this)),"string"==typeof n&&t[n].call(e)})},o.fn.dropdown.Constructor=a,o.fn.dropdown.noConflict=function(){return o.fn.dropdown=e,this},o(document).on("click.bs.dropdown.data-api",i).on("click.bs.dropdown.data-api",".dropdown form",function(e){e.stopPropagation()}).on("click.bs.dropdown.data-api",c,a.prototype.toggle).on("keydown.bs.dropdown.data-api",c+", [role=menu], [role=listbox]",a.prototype.keydown)}(jQuery),function(i){"use strict";var s=function(e,t){this.options=t,this.$element=i(e),this.$backdrop=this.isShown=null,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,i.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))};s.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},s.prototype.toggle=function(e){return this[this.isShown?"hide":"show"](e)},s.prototype.show=function(n){var a=this,e=i.Event("show.bs.modal",{relatedTarget:n});this.$element.trigger(e),this.isShown||e.isDefaultPrevented()||(this.isShown=!0,this.escape(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',i.proxy(this.hide,this)),this.backdrop(function(){var e=i.support.transition&&a.$element.hasClass("fade");a.$element.parent().length||a.$element.appendTo(document.body),a.$element.show().scrollTop(0),e&&a.$element[0].offsetWidth,a.$element.addClass("in").attr("aria-hidden",!1),a.enforceFocus();var t=i.Event("shown.bs.modal",{relatedTarget:n});e?a.$element.find(".modal-dialog").one(i.support.transition.end,function(){a.$element.focus().trigger(t)}).emulateTransitionEnd(300):a.$element.focus().trigger(t)}))},s.prototype.hide=function(e){e&&e.preventDefault(),e=i.Event("hide.bs.modal"),this.$element.trigger(e),this.isShown&&!e.isDefaultPrevented()&&(this.isShown=!1,this.escape(),i(document).off("focusin.bs.modal"),this.$element.removeClass("in").attr("aria-hidden",!0).off("click.dismiss.bs.modal"),i.support.transition&&this.$element.hasClass("fade")?this.$element.one(i.support.transition.end,i.proxy(this.hideModal,this)).emulateTransitionEnd(300):this.hideModal())},s.prototype.enforceFocus=function(){i(document).off("focusin.bs.modal").on("focusin.bs.modal",i.proxy(function(e){this.$element[0]!==e.target&&!this.$element.has(e.target).length&&this.$element.focus()},this))},s.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keyup.dismiss.bs.modal",i.proxy(function(e){27==e.which&&this.hide()},this)):this.isShown||this.$element.off("keyup.dismiss.bs.modal")},s.prototype.hideModal=function(){var e=this;this.$element.hide(),this.backdrop(function(){e.removeBackdrop(),e.$element.trigger("hidden.bs.modal")})},s.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},s.prototype.backdrop=function(e){var t=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var n=i.support.transition&&t;if(this.$backdrop=i('<div class="modal-backdrop '+t+'" />').appendTo(document.body),this.$element.on("click.dismiss.bs.modal",i.proxy(function(e){e.target===e.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus.call(this.$element[0]):this.hide.call(this))},this)),n&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!e)return;n?this.$backdrop.one(i.support.transition.end,e).emulateTransitionEnd(150):e()}else!this.isShown&&this.$backdrop?(this.$backdrop.removeClass("in"),i.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one(i.support.transition.end,e).emulateTransitionEnd(150):e()):e&&e()};var e=i.fn.modal;i.fn.modal=function(a,r){return this.each(function(){var e=i(this),t=e.data("bs.modal"),n=i.extend({},s.DEFAULTS,e.data(),"object"==typeof a&&a);t||e.data("bs.modal",t=new s(this,n)),"string"==typeof a?t[a](r):n.show&&t.show(r)})},i.fn.modal.Constructor=s,i.fn.modal.noConflict=function(){return i.fn.modal=e,this},i(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(e){var t=i(this),n=t.attr("href"),a=i(t.attr("data-target")||n&&n.replace(/.*(?=#[^\s]+$)/,"")),r=a.data("bs.modal")?"toggle":i.extend({remote:!/#/.test(n)&&n},a.data(),t.data());t.is("a")&&e.preventDefault(),a.modal(r,this).one("hide",function(){t.is(":visible")&&t.focus()})}),i(document).on("show.bs.modal",".modal",function(){i(document.body).addClass("modal-open")}).on("hidden.bs.modal",".modal",function(){i(document.body).removeClass("modal-open")})}(jQuery),function(s){"use strict";var a=function(e){this.element=s(e)};a.prototype.show=function(){var e=this.element,t=e.closest("ul:not(.dropdown-menu)"),n=e.data("target");if(n||(n=(n=e.attr("href"))&&n.replace(/.*(?=#[^\s]*$)/,"")),!e.parent("li").hasClass("active")){var a=t.find(".active:last a")[0],r=s.Event("show.bs.tab",{relatedTarget:a});if(e.trigger(r),!r.isDefaultPrevented()){var i=s(n);this.activate(e.parent("li"),t),this.activate(i,i.parent(),function(){e.trigger({type:"shown.bs.tab",relatedTarget:a})})}}},a.prototype.activate=function(e,t,n){function a(){r.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"),e.addClass("active"),i?(e[0].offsetWidth,e.addClass("in")):e.removeClass("fade"),e.parent(".dropdown-menu")&&e.closest("li.dropdown").addClass("active"),n&&n()}var r=t.find("> .active"),i=n&&s.support.transition&&r.hasClass("fade");i?r.one(s.support.transition.end,a).emulateTransitionEnd(150):a(),r.removeClass("in")};var e=s.fn.tab;s.fn.tab=function(n){return this.each(function(){var e=s(this),t=e.data("bs.tab");t||e.data("bs.tab",t=new a(this)),"string"==typeof n&&t[n]()})},s.fn.tab.Constructor=a,s.fn.tab.noConflict=function(){return s.fn.tab=e,this},s(document).on("click.bs.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(e){e.preventDefault(),s(this).tab("show")})}(jQuery),function(c){"use strict";var r=function(e,t){this.$element=c(e),this.options=c.extend({},r.DEFAULTS,t),this.transitioning=null,this.options.parent&&(this.$parent=c(this.options.parent)),this.options.toggle&&this.toggle()};r.DEFAULTS={toggle:!0},r.prototype.dimension=function(){return this.$element.hasClass("width")?"width":"height"},r.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var e=c.Event("show.bs.collapse");if(this.$element.trigger(e),!e.isDefaultPrevented()){var t=this.$parent&&this.$parent.find("> .panel > .in");if(t&&t.length){var n=t.data("bs.collapse");if(n&&n.transitioning)return;t.collapse("hide"),n||t.data("bs.collapse",null)}var a=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")[a](0),this.transitioning=1;var r=function(){this.$element.removeClass("collapsing").addClass("collapse in")[a]("auto"),this.transitioning=0,this.$element.trigger("shown.bs.collapse")};if(!c.support.transition)return r.call(this);var i=c.camelCase(["scroll",a].join("-"));this.$element.one(c.support.transition.end,c.proxy(r,this)).emulateTransitionEnd(350)[a](this.$element[0][i])}}},r.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var e=c.Event("hide.bs.collapse");if(this.$element.trigger(e),!e.isDefaultPrevented()){var t=this.dimension();this.$element[t](this.$element[t]())[0].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse").removeClass("in"),this.transitioning=1;var n=function(){this.transitioning=0,this.$element.trigger("hidden.bs.collapse").removeClass("collapsing").addClass("collapse")};if(!c.support.transition)return n.call(this);this.$element[t](0).one(c.support.transition.end,c.proxy(n,this)).emulateTransitionEnd(350)}}},r.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()};var e=c.fn.collapse;c.fn.collapse=function(a){return this.each(function(){var e=c(this),t=e.data("bs.collapse"),n=c.extend({},r.DEFAULTS,e.data(),"object"==typeof a&&a);!t&&n.toggle&&"show"==a&&(a=!a),t||e.data("bs.collapse",t=new r(this,n)),"string"==typeof a&&t[a]()})},c.fn.collapse.Constructor=r,c.fn.collapse.noConflict=function(){return c.fn.collapse=e,this},c(document).on("click.bs.collapse.data-api","[data-toggle=collapse]",function(e){var t,n=c(this),a=n.attr("data-target")||e.preventDefault()||(t=n.attr("href"))&&t.replace(/.*(?=#[^\s]+$)/,""),r=c(a),i=r.data("bs.collapse"),s=i?"toggle":n.data(),o=n.attr("data-parent"),l=o&&c(o);i&&i.transitioning||(l&&l.find('[data-toggle=collapse][data-parent="'+o+'"]').not(n).addClass("collapsed"),n[r.hasClass("in")?"addClass":"removeClass"]("collapsed")),r.collapse(s)})}(jQuery),function(a){a.fn.emulateTransitionEnd=function(e){var t=!1,n=this;a(this).one(a.support.transition.end,function(){t=!0});return setTimeout(function(){t||a(n).trigger(a.support.transition.end)},e),this},a(function(){a.support.transition=function(){var e=document.createElement("bootstrap"),t={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var n in t)if(void 0!==e.style[n])return{end:t[n]};return!1}()})}(jQuery),function(h){var e,i,t,n,r,f={isMsie:function(){var e=/(msie) ([\w.]+)/i.exec(navigator.userAgent);return!!e&&parseInt(e[2],10)},isBlankString:function(e){return!e||/^\s*$/.test(e)},escapeRegExChars:function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isArray:h.isArray,isFunction:h.isFunction,isObject:h.isPlainObject,isUndefined:function(e){return void 0===e},bind:h.proxy,bindAll:function(e){var t;for(var n in e)h.isFunction(t=e[n])&&(e[n]=h.proxy(t,e))},indexOf:function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return n;return-1},each:h.each,map:h.map,filter:h.grep,every:function(n,a){var r=!0;return n?(h.each(n,function(e,t){if(!(r=a.call(null,t,e,n)))return!1}),!!r):r},some:function(n,a){var r=!1;return n?(h.each(n,function(e,t){if(r=a.call(null,t,e,n))return!1}),!!r):r},mixin:h.extend,getUniqueId:(e=0,function(){return e++}),defer:function(e){setTimeout(e,0)},debounce:function(r,i,s){var o,l;return function(){var e,t,n=this,a=arguments;return e=function(){o=null,s||(l=r.apply(n,a))},t=s&&!o,clearTimeout(o),o=setTimeout(e,i),t&&(l=r.apply(n,a)),l}},throttle:function(n,a){var r,i,s,o,l,c;return l=0,c=function(){l=new Date,s=null,o=n.apply(r,i)},function(){var e=new Date,t=a-(e-l);return r=this,i=arguments,t<=0?(clearTimeout(s),s=null,l=e,o=n.apply(r,i)):s||(s=setTimeout(c,t)),o}},tokenizeQuery:function(e){return h.trim(e).toLowerCase().split(/[\s]+/)},tokenizeText:function(e){return h.trim(e).toLowerCase().split(/[\s\-_]+/)},getProtocol:function(){return location.protocol},noop:function(){}},a=(i=/\s+/,{on:function(e,t){var n;if(!t)return this;for(this._callbacks=this._callbacks||{},e=e.split(i);n=e.shift();)this._callbacks[n]=this._callbacks[n]||[],this._callbacks[n].push(t);return this},trigger:function(e,t){var n,a;if(!this._callbacks)return this;for(e=e.split(i);n=e.shift();)if(a=this._callbacks[n])for(var r=0;r<a.length;r+=1)a[r].call(this,{type:n,data:t});return this}}),s=function(){function e(e){e&&e.el||h.error("EventBus initialized without el"),this.$el=h(e.el)}return f.mixin(e.prototype,{trigger:function(e){var t=[].slice.call(arguments,1);this.$el.trigger("typeahead:"+e,t)}}),e}(),o=function(){var r,e;try{(r=window.localStorage).setItem("~~~","!"),r.removeItem("~~~")}catch(e){r=null}function t(e){this.prefix=["__",e,"__"].join(""),this.ttlKey="__ttl__",this.keyMatcher=new RegExp("^"+this.prefix)}return e=r&&window.JSON?{_prefix:function(e){return this.prefix+e},_ttlKey:function(e){return this._prefix(e)+this.ttlKey},get:function(e){return this.isExpired(e)&&this.remove(e),n(r.getItem(this._prefix(e)))},set:function(e,t,n){return f.isNumber(n)?r.setItem(this._ttlKey(e),i(a()+n)):r.removeItem(this._ttlKey(e)),r.setItem(this._prefix(e),i(t))},remove:function(e){return r.removeItem(this._ttlKey(e)),r.removeItem(this._prefix(e)),this},clear:function(){var e,t,n=[],a=r.length;for(e=0;e<a;e++)(t=r.key(e)).match(this.keyMatcher)&&n.push(t.replace(this.keyMatcher,""));for(e=n.length;e--;)this.remove(n[e]);return this},isExpired:function(e){var t=n(r.getItem(this._ttlKey(e)));return!!(f.isNumber(t)&&a()>t)}}:{get:f.noop,set:f.noop,remove:f.noop,clear:f.noop,isExpired:f.noop},f.mixin(t.prototype,e),t;function a(){return(new Date).getTime()}function i(e){return JSON.stringify(f.isUndefined(e)?null:e)}function n(e){return JSON.parse(e)}}(),l=function(){function e(e){f.bindAll(this),e=e||{},this.sizeLimit=e.sizeLimit||10,this.cache={},this.cachedKeysByAge=[]}return f.mixin(e.prototype,{get:function(e){return this.cache[e]},set:function(e,t){var n;this.cachedKeysByAge.length===this.sizeLimit&&(n=this.cachedKeysByAge.shift(),delete this.cache[n]),this.cache[e]=t,this.cachedKeysByAge.push(e)}}),e}(),m=function(){var t,s,i=0,a={};function e(e){f.bindAll(this),e=f.isString(e)?{url:e}:e,s=s||new l,t=f.isNumber(e.maxParallelRequests)?e.maxParallelRequests:t||6,this.url=e.url,this.wildcard=e.wildcard||"%QUERY",this.filter=e.filter,this.replace=e.replace,this.ajaxSettings={type:"get",cache:e.cache,timeout:e.timeout,dataType:e.dataType||"json",beforeSend:e.beforeSend},this._get=(/^throttle$/i.test(e.rateLimitFn)?f.throttle:f.debounce)(this._get,e.rateLimitWait||300)}return f.mixin(e.prototype,{_get:function(n,a){var r=this;i<t?this._sendRequest(n).done(function(e){var t=r.filter?r.filter(e):e;a&&a(t),s.set(n,e)}):this.onDeckRequestArgs=[].slice.call(arguments,0)},_sendRequest:function(e){var t=this,n=a[e];return n||(i++,n=a[e]=h.ajax(e,this.ajaxSettings).always(function(){i--,a[e]=null,t.onDeckRequestArgs&&(t._get.apply(t,t.onDeckRequestArgs),t.onDeckRequestArgs=null)})),n},get:function(e,t){var n,a,r=this,i=encodeURIComponent(e||"");return t=t||f.noop,n=this.replace?this.replace(this.url,i):this.url.replace(this.wildcard,i),(a=s.get(n))?f.defer(function(){t(r.filter?r.filter(a):a)}):this._get(n,t),!!a}}),e}(),c=function(){var c="thumbprint",d="protocol",u="itemHash",p="adjacencyList";function e(e){f.bindAll(this),f.isString(e.template)&&!e.engine&&h.error("no template engine specified"),e.local||e.prefetch||e.remote||h.error("one of local, prefetch, or remote is required"),this.name=e.name||f.getUniqueId(),this.limit=e.limit||5,this.minLength=e.minLength||1,this.header=e.header,this.footer=e.footer,this.valueKey=e.valueKey||"value",this.template=function(e,t,n){var a,r;f.isFunction(e)?a=e:f.isString(e)?(r=t.compile(e),a=f.bind(r.render,r)):a=function(e){return"<p>"+e[n]+"</p>"};return a}(e.template,e.engine,this.valueKey),this.local=e.local,this.prefetch=e.prefetch,this.remote=e.remote,this.itemHash={},this.adjacencyList={},this.storage=e.name?new o(e.name):null}return f.mixin(e.prototype,{_processLocalData:function(e){this._mergeProcessedData(this._processData(e))},_loadPrefetchData:function(i){var e,t,n,a,r,s,o=this,l="0.9.3"+(i.thumbprint||"");return this.storage&&(e=this.storage.get(c),t=this.storage.get(d),n=this.storage.get(u),a=this.storage.get(p)),r=e!==l||t!==f.getProtocol(),(i=f.isString(i)?{url:i}:i).ttl=f.isNumber(i.ttl)?i.ttl:864e5,n&&a&&!r?(this._mergeProcessedData({itemHash:n,adjacencyList:a}),s=h.Deferred().resolve()):s=h.getJSON(i.url).done(function(e){var t=i.filter?i.filter(e):e,n=o._processData(t),a=n.itemHash,r=n.adjacencyList;o.storage&&(o.storage.set(u,a,i.ttl),o.storage.set(p,r,i.ttl),o.storage.set(c,l,i.ttl),o.storage.set(d,f.getProtocol(),i.ttl));o._mergeProcessedData(n)}),s},_transformDatum:function(e){var t=f.isString(e)?e:e[this.valueKey],n={value:t,tokens:e.tokens||f.tokenizeText(t)};return f.isString(e)?(n.datum={},n.datum[this.valueKey]=e):n.datum=e,n.tokens=f.filter(n.tokens,function(e){return!f.isBlankString(e)}),n.tokens=f.map(n.tokens,function(e){return e.toLowerCase()}),n},_processData:function(e){var a=this,i={},s={};return f.each(e,function(e,t){var n=a._transformDatum(t),r=f.getUniqueId(n.value);i[r]=n,f.each(n.tokens,function(e,t){var n=t.charAt(0),a=s[n]||(s[n]=[r]);!~f.indexOf(a,r)&&a.push(r)})}),{itemHash:i,adjacencyList:s}},_mergeProcessedData:function(e){var a=this;f.mixin(this.itemHash,e.itemHash),f.each(e.adjacencyList,function(e,t){var n=a.adjacencyList[e];a.adjacencyList[e]=n?n.concat(t):t})},_getLocalSuggestions:function(a){var r,i=this,s=[],o=[],l=[];return f.each(a,function(e,t){var n=t.charAt(0);!~f.indexOf(s,n)&&s.push(n)}),f.each(s,function(e,t){var n=i.adjacencyList[t];if(!n)return!1;o.push(n),(!r||n.length<r.length)&&(r=n)}),o.length<s.length?[]:(f.each(r,function(e,t){var n=i.itemHash[t];f.every(o,function(e){return~f.indexOf(e,t)})&&f.every(a,function(t){return f.some(n.tokens,function(e){return 0===e.indexOf(t)})})&&l.push(n)}),l)},initialize:function(){var e;return this.local&&this._processLocalData(this.local),this.transport=this.remote?new m(this.remote):null,e=this.prefetch?this._loadPrefetchData(this.prefetch):h.Deferred().resolve(),this.local=this.prefetch=this.remote=null,this.initialize=function(){return e},e},getSuggestions:function(e,t){var n,a,r=this,i=!1;e.length<this.minLength||(n=f.tokenizeQuery(e),(a=this._getLocalSuggestions(n).slice(0,this.limit)).length<this.limit&&this.transport&&(i=this.transport.get(e,function(e){a=a.slice(0),f.each(e,function(e,t){var n=r._transformDatum(t);return!f.some(a,function(e){return n.value===e.value})&&a.push(n),a.length<r.limit}),t&&t(a)})),!i&&t&&t(a))}}),e}(),d=function(){function e(e){var t,n=this;f.bindAll(this),this.specialKeyCodeMap={9:"tab",27:"esc",37:"left",39:"right",13:"enter",38:"up",40:"down"},this.$hint=h(e.hint),this.$input=h(e.input).on("blur.tt",this._handleBlur).on("focus.tt",this._handleFocus).on("keydown.tt",this._handleSpecialKeyEvent),f.isMsie()?this.$input.on("keydown.tt keypress.tt cut.tt paste.tt",function(e){n.specialKeyCodeMap[e.which||e.keyCode]||f.defer(n._compareQueryToInputValue)}):this.$input.on("input.tt",this._compareQueryToInputValue),this.query=this.$input.val(),this.$overflowHelper=(t=this.$input,h("<span></span>").css({position:"absolute",left:"-9999px",visibility:"hidden",whiteSpace:"nowrap",fontFamily:t.css("font-family"),fontSize:t.css("font-size"),fontStyle:t.css("font-style"),fontVariant:t.css("font-variant"),fontWeight:t.css("font-weight"),wordSpacing:t.css("word-spacing"),letterSpacing:t.css("letter-spacing"),textIndent:t.css("text-indent"),textRendering:t.css("text-rendering"),textTransform:t.css("text-transform")}).insertAfter(t))}return f.mixin(e.prototype,a,{_handleFocus:function(){this.trigger("focused")},_handleBlur:function(){this.trigger("blured")},_handleSpecialKeyEvent:function(e){var t=this.specialKeyCodeMap[e.which||e.keyCode];t&&this.trigger(t+"Keyed",e)},_compareQueryToInputValue:function(){var e,t,n=this.getInputValue(),a=(e=this.query,t=n,e=(e||"").replace(/^\s*/g,"").replace(/\s{2,}/g," "),t=(t||"").replace(/^\s*/g,"").replace(/\s{2,}/g," "),e===t);!!a&&this.query.length!==n.length?this.trigger("whitespaceChanged",{value:this.query}):a||this.trigger("queryChanged",{value:this.query=n})},destroy:function(){this.$hint.off(".tt"),this.$input.off(".tt"),this.$hint=this.$input=this.$overflowHelper=null},focus:function(){this.$input.focus()},blur:function(){this.$input.blur()},getQuery:function(){return this.query},setQuery:function(e){this.query=e},getInputValue:function(){return this.$input.val()},setInputValue:function(e,t){this.$input.val(e),!t&&this._compareQueryToInputValue()},getHintValue:function(){return this.$hint.val()},setHintValue:function(e){this.$hint.val(e)},getLanguageDirection:function(){return(this.$input.css("direction")||"ltr").toLowerCase()},isOverflow:function(){return this.$overflowHelper.text(this.getInputValue()),this.$overflowHelper.width()>this.$input.width()},isCursorAtEnd:function(){var e,t=this.$input.val().length,n=this.$input[0].selectionStart;return f.isNumber(n)?n===t:!document.selection||((e=document.selection.createRange()).moveStart("character",-t),t===e.text.length)}}),e}(),u=function(){var c='<span class="tt-suggestions"></span>',d={display:"block"},u={whiteSpace:"nowrap",cursor:"pointer"},p={whiteSpace:"normal"};function e(e){f.bindAll(this),this.isOpen=!1,this.isEmpty=!0,this.isMouseOverDropdown=!1,this.$menu=h(e.menu).on("mouseenter.tt",this._handleMouseenter).on("mouseleave.tt",this._handleMouseleave).on("click.tt",".tt-suggestion",this._handleSelection).on("mouseover.tt",".tt-suggestion",this._handleMouseover)}return f.mixin(e.prototype,a,{_handleMouseenter:function(){this.isMouseOverDropdown=!0},_handleMouseleave:function(){this.isMouseOverDropdown=!1},_handleMouseover:function(e){var t=h(e.currentTarget);this._getSuggestions().removeClass("tt-is-under-cursor"),t.addClass("tt-is-under-cursor")},_handleSelection:function(e){var t=h(e.currentTarget);this.trigger("suggestionSelected",i(t))},_show:function(){this.$menu.css("display","block")},_hide:function(){this.$menu.hide()},_moveCursor:function(e){var t,n,a,r;this.isVisible()&&((n=(t=this._getSuggestions()).filter(".tt-is-under-cursor")).removeClass("tt-is-under-cursor"),-1!==(a=((a=t.index(n)+e)+1)%(t.length+1)-1)?(a<-1&&(a=t.length-1),r=t.eq(a).addClass("tt-is-under-cursor"),this._ensureVisibility(r),this.trigger("cursorMoved",i(r))):this.trigger("cursorRemoved"))},_getSuggestions:function(){return this.$menu.find(".tt-suggestions > .tt-suggestion")},_ensureVisibility:function(e){var t=this.$menu.height()+parseInt(this.$menu.css("paddingTop"),10)+parseInt(this.$menu.css("paddingBottom"),10),n=this.$menu.scrollTop(),a=e.position().top,r=a+e.outerHeight(!0);a<0?this.$menu.scrollTop(n+a):t<r&&this.$menu.scrollTop(n+(r-t))},destroy:function(){this.$menu.off(".tt"),this.$menu=null},isVisible:function(){return this.isOpen&&!this.isEmpty},closeUnlessMouseIsOverDropdown:function(){this.isMouseOverDropdown||this.close()},close:function(){this.isOpen&&(this.isOpen=!1,this.isMouseOverDropdown=!1,this._hide(),this.$menu.find(".tt-suggestions > .tt-suggestion").removeClass("tt-is-under-cursor"),this.trigger("closed"))},open:function(){this.isOpen||(this.isOpen=!0,!this.isEmpty&&this._show(),this.trigger("opened"))},setLanguageDirection:function(e){"ltr"===e?this.$menu.css({left:"0",right:"auto"}):this.$menu.css({left:"auto",right:" 0"})},moveCursorUp:function(){this._moveCursor(-1)},moveCursorDown:function(){this._moveCursor(1)},getSuggestionUnderCursor:function(){var e=this._getSuggestions().filter(".tt-is-under-cursor").first();return 0<e.length?i(e):null},getFirstSuggestion:function(){var e=this._getSuggestions().first();return 0<e.length?i(e):null},renderSuggestions:function(n,e){var a,t,r,i,s,o="tt-dataset-"+n.name,l=this.$menu.find("."+o);0===l.length&&(t=h(c).css(d),l=h("<div></div>").addClass(o).append(n.header).append(t).append(n.footer).appendTo(this.$menu)),0<e.length?(this.isEmpty=!1,this.isOpen&&this._show(),r=document.createElement("div"),i=document.createDocumentFragment(),f.each(e,function(e,t){t.dataset=n.name,a=n.template(t.datum),r.innerHTML='<div class="tt-suggestion">%body</div>'.replace("%body",a),(s=h(r.firstChild).css(u).data("suggestion",t)).children().each(function(){h(this).css(p)}),i.appendChild(s[0])}),l.show().find(".tt-suggestions").html(i)):this.clearSuggestions(n.name),this.trigger("suggestionsRendered")},clearSuggestions:function(e){var t=e?this.$menu.find(".tt-dataset-"+e):this.$menu.find('[class^="tt-dataset-"]'),n=t.find(".tt-suggestions");t.hide(),n.empty(),0===this._getSuggestions().length&&(this.isEmpty=!0,this._hide())}}),e;function i(e){return e.data("suggestion")}}(),p=function(){var i={wrapper:'<span class="twitter-typeahead"></span>',hint:'<input class="tt-hint" type="text" autocomplete="off" spellcheck="off" disabled>',dropdown:'<span class="tt-dropdown-menu"></span>'},s={wrapper:{position:"relative"},hint:{position:"absolute",top:"0",left:"0",borderColor:"transparent",boxShadow:"none"},query:{position:"relative",verticalAlign:"top","border-radius":"4px 0 0 4px","-moz-border-radius":"4px 0 0 4px","-webkit-border-radius":"4px 0 0 4px"},dropdown:{position:"absolute",top:"100%",left:"0",zIndex:"100",display:"none"}};function e(e){var t,n,a;f.bindAll(this),this.$node=function(e){var t=h(i.wrapper),n=h(i.dropdown),a=h(e),r=h(i.hint);t=t.css(s.wrapper),n=n.css(s.dropdown),r.css(s.hint).css({backgroundAttachment:a.css("background-attachment"),backgroundClip:a.css("background-clip"),backgroundColor:a.css("background-color"),backgroundImage:a.css("background-image"),backgroundOrigin:a.css("background-origin"),backgroundPosition:a.css("background-position"),backgroundRepeat:a.css("background-repeat"),backgroundSize:a.css("background-size")}),a.data("ttAttrs",{dir:a.attr("dir"),autocomplete:a.attr("autocomplete"),spellcheck:a.attr("spellcheck"),style:a.attr("style")}),a.addClass("tt-query").attr({autocomplete:"off",spellcheck:!1}).css(s.query);try{!a.attr("dir")&&a.attr("dir","auto")}catch(e){}return a.wrap(t).parent().prepend(r).append(n)}(e.input),this.datasets=e.datasets,this.dir=null,this.eventBus=e.eventBus,t=this.$node.find(".tt-dropdown-menu"),n=this.$node.find(".tt-query"),a=this.$node.find(".tt-hint"),this.dropdownView=new u({menu:t}).on("suggestionSelected",this._handleSelection).on("cursorMoved",this._clearHint).on("cursorMoved",this._setInputValueToSuggestionUnderCursor).on("cursorRemoved",this._setInputValueToQuery).on("cursorRemoved",this._updateHint).on("suggestionsRendered",this._updateHint).on("opened",this._updateHint).on("closed",this._clearHint).on("opened closed",this._propagateEvent),this.inputView=new d({input:n,hint:a}).on("focused",this._openDropdown).on("blured",this._closeDropdown).on("blured",this._setInputValueToQuery).on("enterKeyed tabKeyed",this._handleSelection).on("queryChanged",this._clearHint).on("queryChanged",this._clearSuggestions).on("queryChanged",this._getSuggestions).on("whitespaceChanged",this._updateHint).on("queryChanged whitespaceChanged",this._openDropdown).on("queryChanged whitespaceChanged",this._setLanguageDirection).on("escKeyed",this._closeDropdown).on("escKeyed",this._setInputValueToQuery).on("tabKeyed upKeyed downKeyed",this._managePreventDefault).on("upKeyed downKeyed",this._moveDropdownCursor).on("upKeyed downKeyed",this._openDropdown).on("tabKeyed leftKeyed rightKeyed",this._autocomplete)}return f.isMsie()&&f.mixin(s.query,{backgroundImage:"url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)"}),f.isMsie()&&f.isMsie()<=7&&(f.mixin(s.wrapper,{display:"inline",zoom:"1"}),f.mixin(s.query,{marginTop:"-1px"})),f.mixin(e.prototype,a,{_managePreventDefault:function(e){var t,n,a=e.data,r=!1;switch(e.type){case"tabKeyed":t=this.inputView.getHintValue(),n=this.inputView.getInputValue(),r=t&&t!==n;break;case"upKeyed":case"downKeyed":r=!a.shiftKey&&!a.ctrlKey&&!a.metaKey}r&&a.preventDefault()},_setLanguageDirection:function(){var e=this.inputView.getLanguageDirection();e!==this.dir&&(this.dir=e,this.$node.css("direction",e),this.dropdownView.setLanguageDirection(e))},_updateHint:function(){var e,t,n,a,r=this.dropdownView.getFirstSuggestion(),i=r?r.value:null,s=this.dropdownView.isVisible(),o=this.inputView.isOverflow();i&&s&&!o&&(t=(e=this.inputView.getInputValue()).replace(/\s{2,}/g," ").replace(/^\s+/g,""),n=f.escapeRegExChars(t),a=new RegExp("^(?:"+n+")(.*$)","i").exec(i),this.inputView.setHintValue(e+(a?a[1]:"")))},_clearHint:function(){this.inputView.setHintValue("")},_clearSuggestions:function(){this.dropdownView.clearSuggestions()},_setInputValueToQuery:function(){this.inputView.setInputValue(this.inputView.getQuery())},_setInputValueToSuggestionUnderCursor:function(e){var t=e.data;this.inputView.setInputValue(t.value,!0)},_openDropdown:function(){this.dropdownView.open()},_closeDropdown:function(e){this.dropdownView["blured"===e.type?"closeUnlessMouseIsOverDropdown":"close"]()},_moveDropdownCursor:function(e){var t=e.data;t.shiftKey||t.ctrlKey||t.metaKey||this.dropdownView["upKeyed"===e.type?"moveCursorUp":"moveCursorDown"]()},_handleSelection:function(e){var t="suggestionSelected"===e.type,n=t?e.data:this.dropdownView.getSuggestionUnderCursor();n&&(this.inputView.setInputValue(n.value),t?this.inputView.focus():e.data.preventDefault(),t&&f.isMsie()?f.defer(this.dropdownView.close):this.dropdownView.close(),this.eventBus.trigger("selected",n.datum,n.dataset))},_getSuggestions:function(){var n=this,a=this.inputView.getQuery();f.isBlankString(a)||f.each(this.datasets,function(e,t){t.getSuggestions(a,function(e){a===n.inputView.getQuery()&&n.dropdownView.renderSuggestions(t,e)})})},_autocomplete:function(e){var t,n,a,r,i;("rightKeyed"!==e.type&&"leftKeyed"!==e.type||(t=this.inputView.isCursorAtEnd(),n="ltr"===this.inputView.getLanguageDirection()?"leftKeyed"===e.type:"rightKeyed"===e.type,t&&!n))&&(a=this.inputView.getQuery(),""!==(r=this.inputView.getHintValue())&&a!==r&&(i=this.dropdownView.getFirstSuggestion(),this.inputView.setInputValue(i.value),this.eventBus.trigger("autocompleted",i.datum,i.dataset)))},_propagateEvent:function(e){this.eventBus.trigger(e.type)},destroy:function(){var e,n;this.inputView.destroy(),this.dropdownView.destroy(),e=this.$node,n=e.find(".tt-query"),f.each(n.data("ttAttrs"),function(e,t){f.isUndefined(t)?n.removeAttr(e):n.attr(e,t)}),n.detach().removeData("ttAttrs").removeClass("tt-query").insertAfter(e),e.remove(),this.$node=null},setQuery:function(e){this.inputView.setQuery(e),this.inputView.setInputValue(e),this._clearHint(),this._clearSuggestions(),this._getSuggestions()}}),e}();n={},r="ttView",t={initialize:function(e){var a;return 0===(e=f.isArray(e)?e:[e]).length&&h.error("no datasets provided"),a=f.map(e,function(e){var t=n[e.name]?n[e.name]:new c(e);return e.name&&(n[e.name]=t),t}),this.each(function(){var e,t=h(this),n=new s({el:t});e=f.map(a,function(e){return e.initialize()}),t.data(r,new p({input:t,eventBus:n=new s({el:t}),datasets:a})),h.when.apply(h,e).always(function(){f.defer(function(){n.trigger("initialized")})})})},destroy:function(){return this.each(function(){var e=h(this),t=e.data(r);t&&(t.destroy(),e.removeData(r))})},setQuery:function(t){return this.each(function(){var e=h(this).data(r);e&&e.setQuery(t)})}},jQuery.fn.typeahead=function(e){return t[e]?t[e].apply(this,[].slice.call(arguments,1)):t.initialize.apply(this,arguments)}}(window.jQuery),function(e,t){if("object"==typeof exports&&exports)t(exports);else{var n={};t(n),"function"==typeof define&&define.amd?define(n):e.Mustache=n}}(this,function(y){var x=/\s*/,b=/\s+/,a=/\S/,w=/\s*=/,k=/\s*\}/,M=/#|\^|\/|>|\{|&|=|!/,r=RegExp.prototype.test;function _(e){return t=a,n=e,!r.call(t,n);var t,n}var t=Object.prototype.toString,f=Array.isArray||function(e){return"[object Array]"===t.call(e)};function $(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function S(e){this.string=e,this.tail=e,this.pos=0}function s(e,t){this.view=e||{},this.parent=t,this._cache={}}function e(){this.clearCache()}function T(e){return[new RegExp($(e[0])+"\\s*"),new RegExp("\\s*"+$(e[1]))]}S.prototype.eos=function(){return""===this.tail},S.prototype.scan=function(e){var t=this.tail.match(e);return t&&0===t.index?(this.tail=this.tail.substring(t[0].length),this.pos+=t[0].length,t[0]):""},S.prototype.scanUntil=function(e){var t,n=this.tail.search(e);switch(n){case-1:t=this.tail,this.pos+=this.tail.length,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,n),this.tail=this.tail.substring(n),this.pos+=n}return t},s.make=function(e){return e instanceof s?e:new s(e)},s.prototype.push=function(e){return new s(e,this)},s.prototype.lookup=function(e){var t=this._cache[e];if(!t){if("."==e)t=this.view;else for(var n=this;n;){if(0<e.indexOf(".")){t=n.view;for(var a=e.split("."),r=0;t&&r<a.length;)t=t[a[r++]]}else t=n.view[e];if(null!=t)break;n=n.parent}this._cache[e]=t}return"function"==typeof t&&(t=t.call(this.view)),t},e.prototype.clearCache=function(){this._cache={},this._partialCache={}},e.prototype.compile=function(e,t){var n=this._cache[e];if(!n){var a=y.parse(e,t);n=this._cache[e]=this.compileTokens(a,e)}return n},e.prototype.compilePartial=function(e,t,n){var a=this.compile(t,n);return this._partialCache[e]=a},e.prototype.getPartial=function(e){return e in this._partialCache||!this._loadPartial||this.compilePartial(e,this._loadPartial(e)),this._partialCache[e]},e.prototype.compileTokens=function(a,r){var i=this;return function(e,t){if(t)if("function"==typeof t)i._loadPartial=t;else for(var n in t)i.compilePartial(n,t[n]);return function e(t,n,a,r){var i="";var s,o,l;for(var c=0,d=t.length;c<d;++c)switch(s=t[c],o=s[1],s[0]){case"#":if("object"==typeof(l=a.lookup(o)))if(f(l))for(var u=0,p=l.length;u<p;++u)i+=e(s[4],n,a.push(l[u]),r);else l&&(i+=e(s[4],n,a.push(l),r));else if("function"==typeof l){var h=null==r?null:r.slice(s[3],s[5]);null!=(l=l.call(a.view,h,function(e){return n.render(e,a)}))&&(i+=l)}else l&&(i+=e(s[4],n,a,r));break;case"^":(!(l=a.lookup(o))||f(l)&&0===l.length)&&(i+=e(s[4],n,a,r));break;case">":"function"==typeof(l=n.getPartial(o))&&(i+=l(a));break;case"&":null!=(l=a.lookup(o))&&(i+=l);break;case"name":null!=(l=a.lookup(o))&&(i+=y.escape(l));break;case"text":i+=o}return i}(a,i,s.make(e),r)}},e.prototype.render=function(e,t,n){return this.compile(e)(t,n)},y.name="mustache.js",y.version="0.7.2",y.tags=["{{","}}"],y.Scanner=S,y.Context=s,y.Writer=e,y.parse=function(e,t){if(e=e||"","string"==typeof(t=t||y.tags)&&(t=t.split(b)),2!==t.length)throw new Error("Invalid tags: "+t.join(", "));var n,a,r,i,s,o=T(t),l=new S(e),c=[],d=[],u=[],p=!1,h=!1;function f(){if(p&&!h)for(;u.length;)delete d[u.pop()];else u=[];h=p=!1}for(;!l.eos();){if(n=l.pos,r=l.scanUntil(o[0]))for(var m=0,g=r.length;m<g;++m)_(i=r.charAt(m))?u.push(d.length):h=!0,d.push(["text",i,n,n+1]),n+=1,"\n"==i&&f();if(!l.scan(o[0]))break;if(p=!0,a=l.scan(M)||"name",l.scan(x),"="===a?(r=l.scanUntil(w),l.scan(w),l.scanUntil(o[1])):"{"===a?(r=l.scanUntil(new RegExp("\\s*"+$("}"+t[1]))),l.scan(k),l.scanUntil(o[1]),a="&"):r=l.scanUntil(o[1]),!l.scan(o[1]))throw new Error("Unclosed tag at "+l.pos);if(s=[a,r,n,l.pos],d.push(s),"#"===a||"^"===a)c.push(s);else if("/"===a){if(0===c.length)throw new Error('Unopened section "'+r+'" at '+n);var v;if((v=c.pop())[1]!==r)throw new Error('Unclosed section "'+v[1]+'" at '+n)}else if("name"===a||"{"===a||"&"===a)h=!0;else if("="===a){if(2!==(t=r.split(b)).length)throw new Error("Invalid tags at "+n+": "+t.join(", "));o=T(t)}}if(v=c.pop())throw new Error('Unclosed section "'+v[1]+'" at '+l.pos);return function(e){for(var t,n=[],a=n,r=[],i=0,s=e.length;i<s;++i)switch((t=e[i])[0]){case"#":case"^":r.push(t),a.push(t),a=t[4]=[];break;case"/":r.pop()[5]=t[2],a=0<r.length?r[r.length-1][4]:n;break;default:a.push(t)}return n}(d=function(e){for(var t,n,a=[],r=0,i=e.length;r<i;++r)(t=e[r])&&("text"===t[0]&&n&&"text"===n[0]?(n[1]+=t[1],n[3]=t[3]):(n=t,a.push(t)));return a}(d))},y.escape=function(e){return String(e).replace(/[&<>"'\/]/g,function(e){return n[e]})};var i=new e;y.clearCache=function(){return i.clearCache()},y.compile=function(e,t){return i.compile(e,t)},y.compilePartial=function(e,t,n){return i.compilePartial(e,t,n)},y.compileTokens=function(e,t){return i.compileTokens(e,t)},y.render=function(e,t,n){return i.render(e,t,n)},y.to_html=function(e,t,n,a){var r=y.render(e,t,n);if("function"!=typeof a)return r;a(r)}});var navMap=function(){var r,c,i,s,o,d={lng:0,lat:0},u={lng:0,lat:0},p=3,h={selectedInterval:{nam:"",mid:"",oid:""},personFilter:{id:"",name:""},taxa:[],stratigraphy:{name:"",rank:""},exist:{selectedInterval:!1,personFilter:!1,taxon:!1,stratigraphy:!1}},l=d3.geo.hammer().scale(165).translate([480,250]).rotate([1e-6,0]).precision(.1),f=d3.geo.path().projection(l);function t(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}return{init:function(n){map=new L.Map("map",{center:new L.LatLng(0,0),zoom:2,maxZoom:11,minZoom:2,zoomControl:!1,inertiaDeceleration:6e3,inertiaMaxSpeed:1e3,zoomAnimationThreshold:1});function t(e){var t=map.getBounds();if(360<Math.abs(t._northEast.lng)+Math.abs(t._southWest.lng)){alert("移动过远");var n=!0}(e<3||3<e&&n||4===p&&3===e&&n)&&700<window.innerWidth&&(p=2,d3.select("#map").style("height",0),d3.select("#svgMap").style("display","block")),navMap.refresh()}L.tileLayer("http://t{s}.tianditu.cn/DataServer?T=vec_w&X={x}&Y={y}&L={z}",{subdomains:["0","1","2","3","4","5","6","7"]}).addTo(map),r=L.tileLayer("http://t{s}.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}",{subdomains:["0","1","2","3","4","5","6","7"]}),map.on("moveend",function(e){e.hard||parseInt(d3.select("#map").style("height"))<2||(t(map.getZoom()),paleo_nav.getPrevalence())}),map.on("zoomend",function(){d3.select(".leaflet-zoom-hide").style("visibility","hidden"),navMap.selectBaseMap(map.getZoom()),t(map.getZoom())}),map._initPathRoot(),d3.select("#map").select("svg").append("g").attr("class","leaflet-zoom-hide").attr("id","binHolder"),d3.select("#map").style("height",0);var e=d3.behavior.zoom().on("zoom",function(){0<d3.event.sourceEvent.wheelDelta?navMap.changeMaps(d3.mouse(this)):"touchmove"===d3.event.sourceEvent.type&&navMap.changeMaps([d3.event.sourceEvent.pageX,d3.event.sourceEvent.pageY])}),a=d3.select("#svgMap").append("svg").attr("width",960).attr("height",500).call(e).on("click",function(){navMap.changeMaps(d3.mouse(this))}).append("g");a.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",f),a.append("use").attr("class","fill").attr("xlink:href","#sphere"),d3.json("build/js/countries_1e5.json",function(e,t){a.append("path").datum(topojson.feature(t,t.objects.countries)).attr("class","countries").attr("d",f),reconstructMap.resize(),timeScale.resize(),setTimeout(navMap.resize,1e3),n()}),d3.text("build/partials/binModal.html",function(e,t){t}),d3.text("build/partials/collectionModal.html",function(e,t){i=t}),d3.text("build/partials/occurrences.html",function(e,t){s=t}),d3.text("build/partials/stackedCollectionModal.html",function(e,t){o=t})},changeMaps:function(e){paleo_nav.getPrevalence();var t=15<$("#time").height()?$("#time").height():window.innerHeight/5.6,n=[window.innerWidth/2,(window.innerHeight-t-70)/2],a=e,r=d3.geo.mercator().scale(165).precision(.1).translate(n).invert(a);d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){if("hidden"===d3.select(".timeScale").style("visibility"))return window.innerHeight-70+"px";var e=15<$("#time").height()?$("#time").height():window.innerHeight/5.6;return window.innerHeight-e-56+"px"}),map.setView([parseInt(r[1]),parseInt(r[0])],3,{animate:!1});var i=map.getBounds();360<Math.abs(i._northEast.lng)+Math.abs(i._southWest.lng)&&map.setZoom(4,{animate:!1}),navMap.refresh("reset"),map.invalidateSize()},goTo:function(e,t){t<3||(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight+"px"}),map._resetView(e,t))},selectBaseMap:function(e){7<=e&&!map.hasLayer(r)?map.addLayer(r):e<7&&map.hasLayer(r)&&map.removeLayer(r)},refresh:function(e){paleo_nav.showLoading(),p-map.getZoom()!=0&&d3.select(".leaflet-zoom-hide").style("visibility","hidden");var t=navMap.checkFilters();if(parseInt(d3.select("#map").style("height"))<1){void 0!==c&&0<Object.keys(c).length&&(c.abort(),c={});var n=paleo_nav.siteUrl+"/data/collections_summary.json?lngmin=-180&lngmax=180&latmin=-90&latmax=90&show=time";if(t){if(!0!==h.exist.selectedInterval||h.exist.personFilter||h.exist.taxon||h.exist.stratigraphy)n+="&level=2",n=navMap.parseURL(n);else if(n+="&level=3",n=navMap.parseURL(n),void 0!==timeScale.interval_hash[h.selectedInterval.oid]){if(void 0!==timeScale.interval_hash[h.selectedInterval.oid].data)return navMap.refreshHammer(timeScale.interval_hash[h.selectedInterval.oid].data);c=d3.json(n,function(e,t){return e?paleo_nav.hideLoading():(timeScale.interval_hash[h.selectedInterval.oid].data=t,navMap.refreshHammer(t))})}}else n+="&level=1",n=navMap.parseURL(n);c=d3.json(n,function(e,t){if(e)return paleo_nav.hideLoading();navMap.refreshHammer(t)})}else{var a=map.getBounds(),r=a._southWest,i=a._northEast,s=map.getZoom();if(r.lat=r.lat.toFixed(4),r.lng=r.lng.toFixed(4),i.lat=i.lat.toFixed(4),i.lng=i.lng.toFixed(4),!e)if(u.lat>i.lat&&u.lng>i.lng&&d.lat<r.lat&&d.lng<r.lng){if(p<3&&2<s);else if(p<5&&4<s);else if(!(p<7&&6<s)){if(p===s)return p=s,void paleo_nav.hideLoading();var o=d3.selectAll(".bins");if(6<s){var l=d3.selectAll(".clusters");return p=s,navMap.redrawPoints(o,l)}return p=s,navMap.redrawPoints(o)}}else if(2<p&&s<7&&t&&!0===h.exist.selectedInterval&&!h.exist.personFilter&&!h.exist.taxon&&!h.exist.stratigraphy)if(d3.select("#binHolder").selectAll("circle")[0].length<1);else if(!(p<7&&6<s||6<p&&s<7)){o=d3.selectAll(".bins");if(6<s){l=d3.selectAll(".clusters");return p=s,navMap.redrawPoints(o,l)}return p=s,navMap.redrawPoints(o)}if(u=i,p=s,(d=r).lat=r.lat<-90?-90:r.lat,i.lat=90<i.lat?90:i.lat,void 0!==c&&0<Object.keys(c).length&&(c.abort(),c={}),s<5&&!1===t){n=paleo_nav.siteUrl+"/data/collections_summary.json?lngmin="+r.lng+"&lngmax="+i.lng+"&latmin="+r.lat+"&latmax="+i.lat+"&level=2&show=time";c=d3.json(navMap.parseURL(n),function(e,t){if(e)return paleo_nav.hideLoading();navMap.drawBins(t,1,s)})}else if(4<s&&s<7||s<5&&!0===t)if(!0!==h.exist.selectedInterval||h.exist.personFilter||h.exist.taxon||h.exist.stratigraphy){n=paleo_nav.siteUrl+"/data/collections_summary.json?lngmin="+r.lng+"&lngmax="+i.lng+"&latmin="+r.lat+"&latmax="+i.lat+"&level=3&show=time";n=navMap.parseURL(n),c=d3.json(n,function(e,t){if(e)return paleo_nav.hideLoading();navMap.drawBins(t,2,s)})}else{var n=paleo_nav.siteUrl+"/data/collections_summary.json?lngmin=-180&lngmax=180&latmin=-90&latmax=90&show=time&level=3";if(n=navMap.parseURL(n),void 0!==timeScale.interval_hash[h.selectedInterval.oid]){if(void 0!==timeScale.interval_hash[h.selectedInterval.oid].data)return navMap.drawBins(timeScale.interval_hash[h.selectedInterval.oid].data,2,s);c=d3.json(n,function(e,t){return e?paleo_nav.hideLoading():(timeScale.interval_hash[h.selectedInterval.oid].data=t,navMap.drawBins(t,2,s))})}}else{n=paleo_nav.siteUrl+"/data/collections_list.json?lngmin="+r.lng+"&lngmax="+i.lng+"&latmin="+r.lat+"&latmax="+i.lat+"&show=ref,time,strat,geo,lith,entname,prot&markrefs";n=navMap.parseURL(n),c=d3.json(n,function(e,t){if(e)return paleo_nav.hideLoading();navMap.drawCollections(t,3,s)})}}},redrawPoints:function(e,t){d3.select(".leaflet-zoom-hide").style("visibility","hidden");var n=map.getZoom();if(n<5)if(navMap.checkFilters())var a=d3.scale.log().domain([1,400]).range([4,30]);else a=d3.scale.linear().domain([1,3140]).range([4,30]);else if(4<n&&n<7)a=d3.scale.log().domain([1,400]).range([4,30]);else a=d3.scale.linear().domain([1,50]).range([12,30]);e.attr("cx",function(e){return map.latLngToLayerPoint([e.lat,e.lng]).x}),e.attr("cy",function(e){return map.latLngToLayerPoint([e.lat,e.lng]).y}),t?(t.attr("cx",function(e){return map.latLngToLayerPoint([e.lat,e.lng]).x}),t.attr("cy",function(e){return map.latLngToLayerPoint([e.lat,e.lng]).y}),t.attr("r",function(e){return a(e.members.length)}),e.attr("r",12)):d3.select("#binHolder").selectAll(".bins")[0].length<30?e.attr("r",8):e.attr("r",function(e){return a(e.nco)*navMap.multiplier(n)<4?4:a(e.nco)*navMap.multiplier(n)}),paleo_nav.hideLoading(),d3.select(".leaflet-zoom-hide").style("visibility","visible")},refreshHammer:function(e){navMap.summarize(e);var t=d3.scale.linear().domain([1,4240]).range([4,15]),n=d3.select("#svgMap").select("svg").select("g"),a=n.selectAll("circle").data(e.records);a.enter().append("circle").attr("id",function(e){return"p"+e.cxi}).attr("class","binsHammer").on("mouseout",function(){navMap.setInfoSummary(),timeScale.unhighlight()}),a.style("fill",function(e){return timeScale.interval_hash[e.cxi]?timeScale.interval_hash[e.cxi].color:"#000"}).attr("id",function(e){return"p"+e.cxi}).attr("r",function(e){return t(e.nco)*navMap.multiplier(2)}).attr("cx",function(e){return l([e.lng,e.lat])[0]}).attr("cy",function(e){return l([e.lng,e.lat])[1]}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nco+" 集合</strong><br>"+e.noc+" 发现").style("display","block"),timeScale.highlight(this)}).on("click",function(e){navMap.changeMaps(d3.mouse(this))}),a.exit().remove(),reconstructMap.reconstructing||paleo_nav.hideLoading()},drawBins:function(e,t,n){navMap.summarize(e),d3.selectAll(".clusters").remove();var a=d3.select("#binHolder").selectAll(".bins").data(e.records);a.attr("id",function(e){return"p"+e.cxi}).style("fill",function(e){return timeScale.interval_hash[e.cxi]?timeScale.interval_hash[e.cxi].color:"#000"}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nco+" 集合</strong><br>"+e.noc+" 发现").style("display","block"),timeScale.highlight(this)}).on("click",function(e){2===t?(d3.select(".info").html("<strong>"+e.nco+" 集合</strong><br>"+e.noc+" 发现").style("display","block"),timeScale.highlight(this),navMap.openBinModal(e)):1===t&&map.setView([e.lat,e.lng],5)}),a.enter().append("circle").attr("class","bins").attr("id",function(e){return"p"+e.cxi}).style("fill",function(e){return timeScale.interval_hash[e.cxi]?timeScale.interval_hash[e.cxi].color:"#000"}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nco+" 集合</strong><br>"+e.noc+" 发现").style("display","block"),timeScale.highlight(this)}).on("click",function(e){2===t?(d3.select(".info").html("<strong>"+e.nco+" 集合</strong><br>"+e.noc+" 发现").style("display","block"),timeScale.highlight(this),navMap.openBinModal(e)):1===t&&map.setView([e.lat,e.lng],5)}).on("mouseout",function(){navMap.setInfoSummary(),timeScale.unhighlight()}),a.exit().remove(),navMap.redrawPoints(a)},drawCollections:function(e,t,n){navMap.summarize(e);for(var a=d3.select("#binHolder"),r=[],i=0;i<e.records.length;i++)for(var s=0;s<e.records.length;s++)if(e.records[i].lat===e.records[s].lat&&e.records[i].lng===e.records[s].lng&&e.records[i].oid!=e.records[s].oid){for(var o={lat:e.records[i].lat,lng:e.records[i].lng,members:[]},l=0,c=0;c<r.length;c++)o.lat===r[c].lat&&o.lng===r[c].lng&&(l+=1);if(l<1){r.push(o);break}break}var d=[];for(i=0;i<r.length;i++)for(s=0;s<e.records.length;s++)r[i].lat===e.records[s].lat&&r[i].lng===e.records[s].lng&&(r[i].members.push(e.records[s]),d.push(e.records[s].oid));for(i=0;i<d.length;i++){var u=navMap.getIndex(e.records,d[i],"oid");e.records.splice(u,1)}r.forEach(function(e){var t=[];e.members.forEach(function(e){t.push(e.noc)}),e.cxi=e.members[0].cxi,e.noc=d3.sum(t),e.nam=e.members.length+" Collections"}),(r=a.selectAll(".clusters").data(r)).attr("id",function(e){return"p"+e.members[0].cxi}).style("fill",function(e){return timeScale.interval_hash[e.cxi].color}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" 发现").style("display","block"),timeScale.highlight(this)}).on("click",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" 发现").style("display","block"),timeScale.highlight(this),navMap.openStackedCollectionModal(e)}).on("mouseout",function(e){navMap.setInfoSummary(),timeScale.unhighlight()}),r.enter().append("circle").attr("class","clusters").attr("id",function(e){return"p"+e.members[0].cxi}).style("fill",function(e){return timeScale.interval_hash[e.members[0].cxi]?timeScale.interval_hash[e.members[0].cxi].color:"#000"}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.members.length+" 集合</strong><br>"+e.noc+" 发现").style("display","block"),timeScale.highlight(this)}).on("mouseout",function(e){navMap.setInfoSummary(),timeScale.unhighlight()}).on("click",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" 发现").style("display","block"),timeScale.highlight(this),navMap.openStackedCollectionModal(e)}),r.exit().remove();var p=a.selectAll(".bins").data(e.records);p.attr("id",function(e){return"p"+e.cxi}).style("fill",function(e){return timeScale.interval_hash[e.cxi]?timeScale.interval_hash[e.cxi].color:"#000"}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openCollectionModal(e)}).on("mouseout",function(e){navMap.setInfoSummary(),timeScale.unhighlight()});p.enter().append("circle").attr("id",function(e){return"p"+e.cxi}).attr("class","bins").style("fill",function(e){return timeScale.interval_hash[e.cxi]?timeScale.interval_hash[e.cxi].color:"#000"}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openCollectionModal(e)}).on("mouseout",function(e){navMap.setInfoSummary(),timeScale.unhighlight()}),p.exit().remove(),navMap.redrawPoints(p,r)},getOffsetCollections:function(e,a){d3.json(paleo_nav.siteUrl+"/data/collections_list.json?clust_id="+e+"&show=ref,loc,time,strat,geo,lith,entname,prot&markrefs&limit=20&offset="+a,function(e,t){if(e)return paleo_nav.hideLoading();t.records.forEach(function(e){e.intervals=e.oli?e.oei+" - "+e.oli:e.oei,e.strat=!!(e.sfm||e.sgr||e.smb),e.lat=Math.round(1e4*e.lat)/1e4,e.lng=Math.round(1e4*e.lng)/1e4,e.oid=e.oid.replace(":","")});var n=Mustache.render(o,{members:t.records});$("#collectionCount").html("Showing "+a+" of "+t.records_found+" collections"),$("#collectionAccordion").append(n),($(".show-more-collections").data()["shown-collections"]=a)>=$(".show-more-collections").data("total-collections")&&$(".show-more-collections").hide(),$(".occurrenceTab").on("show.bs.tab",function(e){var r=e.target.id;r=r.replace("occToggle","");var t=navMap.parseURL(paleo_nav.siteUrl+"/occurrences_list.json?coll_id="+r+"&show=phylo,ident");d3.json(t,function(e,t){if(e)return paleo_nav.hideLoading();if(0<t.records.length){var n=navMap.buildTaxonHierarchy(t),a=Mustache.render(s,n);$("#occurrences"+r).html(a),$(".filterByOccurrence").click(function(e){e.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})}else{a=Mustache.render(s,{error:"No occurrences found for this collection"});$("#occurrences"+r).html(a)}})}),$("#collectionLoading").hide()})},openBinModal:function(e,t,n,a){$("#loading").show();var r=e.properties?e.properties.oid:e.oid,i=paleo_nav.siteUrl+"/data/collections_list.json?clust_id="+r;i=navMap.parseURL(i),i+="&show=ref,loc,time,strat,geo,lith,entname,prot&markrefs&limit=20&rowcount",d3.json(i,function(e,t){if(e)return paleo_nav.hideLoading();t.records.forEach(function(e){e.intervals=e.oli?e.oei+" - "+e.oli:e.oei,e.strat=!!(e.sfm||e.sgr||e.smb),e.lat=Math.round(1e4*e.lat)/1e4,e.lng=Math.round(1e4*e.lng)/1e4,e.oid=e.oid.replace("col:","")});var n=Mustache.render(o,{members:t.records});d3.select("#collectionCount").html("Showing "+t.records.length+" of "+t.records_found+" collections"),d3.select("#collectionAccordion").html(n),$(".show-more-collections").data("total-collections",t.records_found).data("shown-collections",t.records_returned),$(".collectionCollapse").on("show.bs.collapse",function(e){var n=e.target.id;n=n.replace("collapse",""),d3.json(paleo_nav.siteUrl+"/data/collections_single.json?id="+n+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(e,t){if(e)return paleo_nav.hideLoading();$("#ref"+n).html(t.records[0].ref)})}),$(".occurrenceTab").on("show.bs.tab",function(e){var r=e.target.id;r=r.replace("occToggle","");var t=navMap.parseURL(paleo_nav.siteUrl+"/data/occurrences_list.json?coll_id="+r+"&show=phylo,ident");d3.json(t,function(e,t){if(e)return paleo_nav.hideLoading();if(0<t.records.length){var n=navMap.buildTaxonHierarchy(t),a=Mustache.render(s,n);$("#occurrences"+r).html(a),$(".filterByOccurrence").click(function(e){e.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})}else{a=Mustache.render(s,{error:"No occurrences found for this collection"});$("#occurrences"+r).html(a)}})}),t.records_found<=t.records_returned?($(".show-more-collections").hide(),$("#collectionCount").hide()):$(".show-more-collections").show().off("click").on("click",function(){$("#collectionLoading").show(),$(".show-more-collections").data().offset+=20,navMap.getOffsetCollections(r,$(".show-more-collections").data().offset)}),$("#binModal").modal(),$("#loading").hide()})},buildTaxonHierarchy:function(e){var m={phyla:[]};e.records.forEach(function(e){if(e.rank=e.rnk?taxaBrowser.rankMap(e.rnk):e.idr?taxaBrowser.rankMap(e.idr):"Unknown",e.italics=e.rnk<6?"italics":"",void 0===e.tna&&(e.tna=e.idn),e.old_name=e.tna.split(" ")[0]!=e.idg?e.tna:"",e.url="species"===e.rank?e.idg+" "+e.ids:e.tid&&0<e.tid.split(":")[1]?e.idg:"",e.idg){var t=e.rsg?e.rsg+" ":"",n=e.rss?" "+e.rss+" ":" ";e.genusRes=t,"species"===e.rank?(e.display_name1=e.tna,e.display_name2=e.tna!=e.idg+" "+e.ids?"("+e.tna+")":"",e.display_name3=""):(e.display_name1=e.idg,e.display_name2=n,e.display_name3=e.ids)}else e.display_name1=e.tna,e.display_name2="";for(var a=[],r=0;r<m.phyla.length;r++)a.push(m.phyla[r].phylum);if(a.indexOf(e.phl)<0){var i={phylum:e.phl,classes:[]};m.phyla.push(i)}var s=[];for(r=0;r<m.phyla.length;r++)for(var o=0;o<m.phyla[r].classes.length;o++)s.push(m.phyla[r].phylum+"-"+m.phyla[r].classes[o].nameClass);if(s.indexOf(e.phl+"-"+e.cll)<0){var l={nameClass:e.cll,families:[]},c=navMap.getIndex(m.phyla,e.phl,"phylum");m.phyla[c].classes.push(l)}var d=[];for(r=0;r<m.phyla.length;r++)for(o=0;o<m.phyla[r].classes.length;o++)for(var u=0;u<m.phyla[r].classes[o].families.length;u++)d.push(m.phyla[r].phylum+"-"+m.phyla[r].classes[o].nameClass+"-"+m.phyla[r].classes[o].families[u].family);if(d.indexOf(e.phl+"-"+e.cll+"-"+e.fml)<0){var p={family:e.fml,genera:[]},h=(c=navMap.getIndex(m.phyla,e.phl,"phylum"),navMap.getIndex(m.phyla[c].classes,e.cll,"nameClass"));m.phyla[c].classes[h].families.push(p)}c=navMap.getIndex(m.phyla,e.phl,"phylum"),h=navMap.getIndex(m.phyla[c].classes,e.cll,"nameClass");var f=navMap.getIndex(m.phyla[c].classes[h].families,e.fml,"family");m.phyla[c].classes[h].families[f].genera.push(e)});for(var t=0;t<m.phyla.length;t++){for(var n=0;n<m.phyla[t].classes.length;n++){for(var a,r=0;r<m.phyla[t].classes[n].families.length;r++)void 0===m.phyla[t].classes[n].families[r].family&&(a=r,m.phyla[t].classes[n].families[r].family=(m.phyla[t].classes[n].nameClass,"Miscellaneous unranked taxa"),m.phyla[t].classes[n].families[r].noFamily=!0);void 0!==a&&m.phyla[t].classes[n].families.push(m.phyla[t].classes[n].families.splice(a,1)[0]),void 0===m.phyla[t].classes[n].nameClass&&(a=n,m.phyla[t].classes[n].nameClass=(m.phyla[t].phylum,"Miscellaneous unranked taxa"),m.phyla[t].classes[n].noClass=!0)}0,void 0===m.phyla[t].phylum&&(m.phyla[t].phylum="Unranked taxa",m.phyla[t].unranked=!0)}return m},openCollectionModal:function(e){$("#loading").show(),d3.json(paleo_nav.siteUrl+"/data/collections_single.json?id="+e.oid+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(e,t){if(e)return paleo_nav.hideLoading();t.records.forEach(function(e){e.intervals=e.oli?e.oei+" - "+e.oli:e.oei,e.strat=!!(e.sfm||e.sgr||e.smb),e.lat=Math.round(1e4*e.lat)/1e4,e.lng=Math.round(1e4*e.lng)/1e4,e.oid=e.oid.replace("col:","")});var n=Mustache.render(i,t);switch($("#collectionName").html(t.records[0].nam),$("#collectionModalBody").html(n),t.records[0].ptd){case"NPS":$(".nationalParks").css("display","block"),$(".general, .federalLands").css("display","none");break;case"FED":$(".federalLands").css("display","block"),$(".general, .nationalParks").css("display","none");break;default:$(".general").css("display","block"),$(".nationalParks, .federalLands").css("display","none")}$(".filterByStrat").click(function(e){e.preventDefault(),navMap.filterByStratigraphy({name:$(this).attr("data-name"),type:$(this).attr("data-rank")}),$("#collectionBox").modal("hide")}),$("#collectionBox").modal(),$(".occurrenceTab").on("show.bs.tab",function(e){var r=e.target.id;r=r.replace("occToggle","");var t=navMap.parseURL(paleo_nav.siteUrl+"/data/occurrences_list.json?coll_id="+r+"&show=phylo,ident");d3.json(t,function(e,t){if(e)return paleo_nav.hideLoading();if(0<t.records.length){var n=navMap.buildTaxonHierarchy(t),a=Mustache.render(s,n);$("#occurrences"+r).html(a),$(".filterByOccurrence").click(function(e){e.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionBox").modal("hide")})}else{a=Mustache.render(s,{error:"No occurrences found for this collection"});$("#occurrences"+r).html(a)}})}),$("#loading").hide()})},openStackedCollectionModal:function(e){var t=e.members[0].ptd;e.members.forEach(function(e){e.intervals=e.oli?e.oei+" - "+e.oli:e.oei,e.strat=!!(e.sfm||e.sgr||e.smb),e.lat=Math.round(1e4*e.lat)/1e4,e.lng=Math.round(1e4*e.lng)/1e4,e.oid=e.oid.replace("col:","")});var n=Mustache.render(o,e);switch(d3.select("#binID").html("Fossil Collections at ["+Math.round(1e4*e.lat)/1e4+", "+Math.round(1e4*e.lng)/1e4+"]"),d3.select("#accordion").html(n),$(".collectionCollapse").on("show.bs.collapse",function(e){var n=e.target.id;n=n.replace("collapse",""),d3.json(paleo_nav.siteUrl+"/data/collections_single.json?id="+n+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(e,t){if(e)return paleo_nav.hideLoading();$("#ref"+n).html(t.records[0].ref)})}),$(".occurrenceTab").on("show.bs.tab",function(e){var r=e.target.id;r=r.replace("occToggle","");var t=navMap.parseURL(paleo_nav.siteUrl+"/data/occurrences_list.json?coll_id="+r+"&show=phylo,ident");d3.json(t,function(e,t){if(e)return paleo_nav.hideLoading();if(0<t.records.length){var n=navMap.buildTaxonHierarchy(t),a=Mustache.render(s,n);$("#occurrences"+r).html(a),$(".filterByOccurrence").click(function(e){e.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})}else{a=Mustache.render(s,{error:"No occurrences found for this collection"});$("#occurrences"+r).html(a)}})}),t){case"NPS":$(".nationalParks").css("display","block"),$(".general, .federalLands").css("display","none");break;case"FED":$(".federalLands").css("display","block"),$(".general, .nationalParks").css("display","none");break;default:$(".general").css("display","block"),$(".nationalParks, .federalLands").css("display","none")}$(".filterByStrat").click(function(e){e.preventDefault(),navMap.filterByStratigraphy({name:$(this).attr("data-name"),type:$(this).attr("data-rank")}),$("#collectionModal").modal("hide")}),$("#collectionModal").modal()},buildWKT:function(e){for(var t="",n=0;n<e.length;n++)t+="POINT("+e[n].lat+" "+e[n].lng+" "+e[n].oid+"),";return t=t.slice(0,-1),t=encodeURI(t)},parseURL:function(t){var e=0;for(var n in h.exist)if(h.exist.hasOwnProperty(n)&&!0===h.exist[n]){switch(n){case"selectedInterval":t+="&interval_id="+h.selectedInterval.oid;break;case"personFilter":t+="&occs_authent_by="+h.personFilter.id;break;case"taxon":t+="&base_id=",h.taxa.forEach(function(e){t+=e.id+","}),t=t.slice(0,-1);break;case"stratigraphy":"Fm"===h.stratigraphy.rank?t+="&formation="+h.stratigraphy.name:"Gp"===h.stratigraphy.rank?t+="&stratgroup="+h.stratigraphy.name:"Mbr"===h.stratigraphy.rank&&(t+="&member="+h.stratigraphy.name)}e+=1}return 0<e&&"none"===d3.select("#reconstructMap").style("display")&&d3.select(".filters").style("display","block"),t},checkFilters:function(){var e=0;for(var t in h.exist)h.exist.hasOwnProperty(t)&&!0===h.exist[t]&&(e+=1);return 0<e?(d3.select(".filters").style("display","block"),d3.select("#filterTitle").text("过滤"),!0):(d3.select(".filters").style("display","none"),d3.select("#filterTitle").text("未选过滤选项"),!1)},getIndex:function(e,t,n){for(var a=0,r=e.length;a<r;a++)if(e[a][n]===t)return a;return-1},multiplier:function(e){switch(e){case 2:return navMap.checkFilters()?.8:.7;case 3:return navMap.checkFilters()?.2:1;case 4:return navMap.checkFilters()?.48:2;case 5:return navMap.checkFilters()?.68:.6;case 6:return navMap.checkFilters()?.88:.8;case 7:return 1.5;default:return 1}},resizeSvgMap:function(){var a=parseInt(d3.select("#graphics").style("width")),r=d3.select("#svgMap").select("svg");d3.select("#svgMap").select("svg").select("g").attr("transform",function(){var t;try{t=r.node().getBBox()}catch(e){t={x:r.node().clientLeft,y:r.node().clientTop,width:r.node().clientWidth,height:r.node().clientHeight}}window.innerHeight;if(a>t.width+70)return"scale("+window.innerHeight/680+")translate("+(a-t.width)/3+",0)";var e=.7*window.innerHeight-70,n=a/970*500;return"scale("+a/970+")translate(0,"+(0<(e-n)/2?(e-n)/2:40)+")"}),d3.select("#svgMap").select("svg").style("height",function(e){if("hidden"===d3.select(".timeScale").style("visibility"))return window.innerHeight-60+"px";var t=15<$("#time").height()?$("#time").height():window.innerHeight/5.6;return window.innerHeight-t-60+"px"}).style("width",function(e){return a-15+"px"})},resize:function(){window.innerWidth<700?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return window.innerHeight-55+"px"}),map.invalidateSize(),$("#downloadDataTab").removeClass("active"),$("#downloadData").removeClass("active"),$("#urlTab").addClass("active"),$("#getURL").addClass("active")):1<parseInt(d3.select("#map").style("height"))?(d3.select("#map").style("height",function(e){if("hidden"===d3.select(".timeScale").style("visibility"))return window.innerHeight-70+"px";var t=15<$("#time").height()?$("#time").height():window.innerHeight/5.6;return window.innerHeight-t-54+"px"}),map.invalidateSize()):navMap.resizeSvgMap(),d3.select("#infoContainer").style("bottom",function(){return window.innerWidth<468?"91px":parseInt(d3.select("#time").select("svg").style("height"))+15+"px"}),d3.select(".prevalence-summary, .prevalence-row").style("height",function(){return window.innerHeight-parseInt(d3.select("#time").select("svg").style("height"))-121+"px"}),600<window.innerHeight?d3.select(".filters").style("left",0).style("top","inherit").style("bottom",function(){return parseInt(d3.select("#time").select("svg").style("height"))+4+"px"}):d3.select(".filters").style("left","49px").style("top",0).style("bottom","inherit"),d3.selectAll(".helpModalTimescaleLabel").style("top",function(){var e=15<$("#time").height()?$("#time").height():window.innerHeight/5.6;return window.innerHeight-e-78+"px"}),$(".universalSearchForm > div > .twitter-typeahead > .tt-dropdown-menu").width($(".universalSearchForm > div > .twitter-typeahead").width()-21)},refreshFilterHandlers:function(){d3.selectAll(".removeFilter").on("click",function(){var e=d3.select(this).node().parentNode,t=(e=d3.select(e)).attr("id"),n=parseInt(e.attr("data-id"));switch(t){case"selectedInterval":e.style("display","none").html(""),h.exist.selectedInterval=!1,d3.select(".time").style("box-shadow",""),timeScale.unhighlight();for(var a=Object.keys(h[t]),r=0;r<a.length;r++)h[t][a[r]]="";break;case"personFilter":e.style("display","none").html(""),h.exist.personFilter=!1,d3.select(".userFilter").style("box-shadow","");for(a=Object.keys(h[t]),r=0;r<a.length;r++)h[t][a[r]]="";break;case"taxon":e.remove(),navMap.removeTaxonFilters([n]);break;case"stratFilter":e.style("display","none").html(""),h.exist.stratigraphy=!1;for(a=Object.keys(h.stratigraphy),r=0;r<a.length;r++)h.stratigraphy[a[r]]=""}paleo_nav.getPrevalence(),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(h.selectedInterval):navMap.refresh("reset")})},updateFilterList:function(e,n){switch(paleo_nav.getPrevalence(),e){case"selectedInterval":d3.select("#selectedInterval").style("display","block").html(h.selectedInterval.nam+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".time").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"personFilter":d3.select("#personFilter").style("display","block").html(h.personFilter.name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".userFilter").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"taxon":var a;h.taxa.forEach(function(e,t){e.id===n&&(a=t)}),d3.select(".filters").append("div").attr("id","taxon").attr("class","filter").attr("data-id",n).style("display","block").html(h.taxa[a].name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".taxa").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"stratigraphy":d3.select("#stratFilter").style("display","block").html(h.stratigraphy.name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),navMap.refreshFilterHandlers()}600<window.innerHeight?d3.select(".filters").style("left",0).style("top","inherit").style("bottom",function(){return parseInt(d3.select("#time").select("svg").style("height"))+4+"px"}):d3.select(".filters").style("left","49px").style("top",0).style("bottom","inherit")},filterByTime:function(t){var e=d3.selectAll("rect").filter(function(e){return e.name===t});e=e[0][0].__data__,h.selectedInterval.nam=e.name,h.selectedInterval.mid=e.mid,h.selectedInterval.col=e.color,h.selectedInterval.oid=e.id,h.exist.selectedInterval=!0,navMap.updateFilterList("selectedInterval")},removeTaxonFilters:function(n){d3.selectAll(".filters > .filter").each(function(e){var t=parseInt(d3.select(this).attr("data-id"));-1<n.indexOf(t)&&d3.select(this).remove()}),navMap.filters.taxa=navMap.filters.taxa.filter(function(e){if(n.indexOf(e.id)<0)return e}),navMap.filters.taxa.length<1&&(navMap.filters.exist.taxon=!1),d3.select(".taxa").style("box-shadow","")},filterByTaxon:function(i,s){if(!i)i=$("#taxonInput").val();var e;e=i.match(/^txn:|^var:/)?"id="+i:"name="+i,d3.json(paleo_nav.siteUrl+"/data/list.json?"+e+"&show=seq",function(e,t){if(e)return alert("Error retrieving from list.json - ",e),paleo_nav.hideLoading();if(0<t.records.length){for(var n={id:parseInt(t.records[0].oid.replace("txn:","")),name:t.records[0].nam,lsq:t.records[0].lsq,rsq:t.records[0].rsq},a=0;a<navMap.filters.taxa.length;a++)if(navMap.filters.taxa[a].id===n.name)return;var r=[];for(a=0;a<navMap.filters.taxa.length;a++)n.lsq>=navMap.filters.taxa[a].lsq&&n.rsq<=navMap.filters.taxa[a].rsq&&r.push(navMap.filters.taxa[a].id),n.lsq<=navMap.filters.taxa[a].lsq&&n.rsq>=navMap.filters.taxa[a].rsq&&r.push(navMap.filters.taxa[a].id);navMap.removeTaxonFilters(r),s||taxaBrowser.goToTaxon(i),navMap.filters.taxa.push(n),navMap.filters.exist.taxon=!0,navMap.updateFilterList("taxon",n.id),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(navMap.filters.selectedInterval):navMap.refresh("reset")}else alert("No taxa with this name found")})},filterByPerson:function(e,t){e&&(h.exist.personFilter=!0,h.personFilter.id=e.oid?e.oid:e.id,h.personFilter.name=e.name?e.name:e.nam,navMap.updateFilterList("personFilter"),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(h.selectedInterval):navMap.refresh("reset"))},filterByStratigraphy:function(e){e&&(h.exist.stratigraphy=!0,h.stratigraphy.name=e.nam,h.stratigraphy.rank=e.type?e.type:e.rank,navMap.updateFilterList("stratigraphy"),navMap.refresh("reset"))},download:function(){0<$("#occs:checked").length?navMap.downloadOccs():0<$("#refs:checked").length?navMap.downloadRefs():0<$("#diver:checked").length?navMap.downloadDiversity():navMap.downloadFullDiversity()},downloadRefs:function(){var e=map.getBounds(),t=e._southWest,n=e._northEast,a=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/refs.";0<$("#tsv:checked").length?a+="txt":0<$("#csv:checked").length?a+="csv":0<$("#json:checked").length?a+="json":a+="ris","block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?a+="?":(t.lat=t.lat.toFixed(4),t.lng=t.lng.toFixed(4),n.lat=n.lat.toFixed(4),n.lng=n.lng.toFixed(4),a+="?lngmin="+t.lng+"&lngmax="+n.lng+"&latmin="+t.lat+"&latmax="+n.lat),a=navMap.parseURL(a),a+="&show=comments,ent,entname,crmod&datainfo",window.open(a)},downloadOccs:function(){var e=map.getBounds(),t=e._southWest,n=e._northEast,a=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.";if(0<$("#tsv:checked").length)a+="txt";else if(0<$("#csv:checked").length)a+="csv";else{if(!(0<$("#json:checked").length))return alert("RIS format not available for occurrences. Please select a different format.");a+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?a+="?":(t.lat=t.lat.toFixed(4),t.lng=t.lng.toFixed(4),n.lat=n.lat.toFixed(4),n.lng=n.lng.toFixed(4),a+="?lngmin="+t.lng+"&lngmax="+n.lng+"&latmin="+t.lat+"&latmax="+n.lat),(a=navMap.parseURL(a))==paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.csv?"&&(a+="&all_records"),a+="&show=coords,attr,loc,prot,time,strat,stratext,lith,lithext,geo,rem,ent,entname,crmod,paleoloc&datainfo",window.open(a)},downloadDiversity:function(){var e=map.getBounds(),t=e._southWest,n=e._northEast,a=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/quickdiv.";if(0<$("#tsv:checked").length)a+="txt";else if(0<$("#csv:checked").length)a+="csv";else{if(!(0<$("#json:checked").length))return alert("RIS format not available for occurrences. Please select a different format.");a+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?a+="?lngmin=-180&lngmax=180&latmin=-90&latmax=90":(t.lat=t.lat.toFixed(4),t.lng=t.lng.toFixed(4),n.lat=n.lat.toFixed(4),n.lng=n.lng.toFixed(4),a+="?lngmin="+t.lng+"&lngmax="+n.lng+"&latmin="+t.lat+"&latmax="+n.lat),a=navMap.parseURL(a),a+="&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val(),window.open(a)},downloadFullDiversity:function(){var e=map.getBounds(),t=e._southWest,n=e._northEast,a=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/diversity.";if(0<$("#tsv:checked").length)a+="txt";else if(0<$("#csv:checked").length)a+="csv";else{if(!(0<$("#json:checked").length))return alert("RIS format not available for occurrences. Please select a different format.");a+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?a+="?lngmin=-180&lngmax=180&latmin=-90&latmax=90":(t.lat=t.lat.toFixed(4),t.lng=t.lng.toFixed(4),n.lat=n.lat.toFixed(4),n.lng=n.lng.toFixed(4),a+="?lngmin="+t.lng+"&lngmax="+n.lng+"&latmin="+t.lat+"&latmax="+n.lat),a=navMap.parseURL(a),a+="&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val()+"&recent="+$('[name="extant"]').is(":checked"),window.open(a)},getApiUrl:function(){var e=map.getBounds(),t=e._southWest,n=e._northEast,a=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.json";return"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?a+="?":(t.lat=t.lat.toFixed(4),t.lng=t.lng.toFixed(4),n.lat=n.lat.toFixed(4),n.lng=n.lng.toFixed(4),a+="?lngmin="+t.lng+"&lngmax="+n.lng+"&latmin="+t.lat+"&latmax="+n.lat),a=navMap.parseURL(a),a+="&show=coords,attr,loc,prot,time,strat,stratext,lith,lithext,geo,rem,ent,entname,crmod&datainfo"},restoreState:function(e){if("object"==typeof e){var t=e;t.zoom&&2<t.zoom&&navMap.goTo(t.center,t.zoom),t.timeScale&&"Phanerozoic"!=t.timeScale&&timeScale.goTo(t.timeScale),0<t.taxaFilter.length&&t.taxaFilter.forEach(function(e){navMap.filterByTaxon(e.name?e.name:e.nam)}),"object"==typeof t.stratFilter&&""!=t.stratFilter.name&&navMap.filterByStratigraphy(t.stratFilter),"object"==typeof t.timeFilter&&""!=t.timeFilter.nam&&navMap.filterByTime(t.timeFilter.nam),0<t.authFilter.id&&navMap.filterByPerson(t.authFilter),"block"===t.reconstruct&&(reconstructMap.rotate(t.currentReconstruction),paleo_nav.toggleReconstructMap(),navMap.checkFilters()),navMap.resize(),window.scrollTo(0,0)}else{1<(e=window.location.hash.substr(2)).length&&d3.json(paleo_nav.stateUrl+"/larkin/app-state?id="+e,function(e,t){if(e)return paleo_nav.launch();var n=t[0].data;n.zoom=parseInt(n.zoom),n.center[0]=parseFloat(n.center[0]),n.center[1]=parseFloat(n.center[1]),n.taxaFilter&&0<n.taxaFilter.length&&n.taxaFilter.forEach(function(e){e.id=parseInt(e.id)}),n.timeFilter.mid=parseInt(n.timeFilter.mid),n.timeFilter.oid=parseInt(n.timeFilter.oid),n.currentReconstruction.mid=parseInt(n.currentReconstruction.mid),n.currentReconstruction.id=parseInt(n.currentReconstruction.id),n.authFilter.id=parseInt(n.authFilter.id),n.zoom&&2<n.zoom&&navMap.goTo(n.center,n.zoom),n.taxaFilter&&0<n.taxaFilter.length&&n.taxaFilter.forEach(function(e){navMap.filterByTaxon(e.name)}),"object"==typeof n.stratFilter&&""!=n.stratFilter.name&&navMap.filterByStratigraphy(n.stratFilter),"object"==typeof n.timeFilter&&""!=n.timeFilter.nam&&(navMap.filterByTime(n.timeFilter.nam),navMap.refresh("redraw")),0<n.authFilter.id&&navMap.filterByPerson(n.authFilter),"block"===n.reconstruct&&(reconstructMap.rotate(n.currentReconstruction),paleo_nav.toggleReconstructMap(),navMap.checkFilters()),"Phanerozoic"!=n.timeScale&&timeScale.goTo(n.timeScale),paleo_nav.launch()})}},getUrl:function(){var e=map.getCenter(),t=map.getZoom(),n=d3.select("#reconstructMap").style("display"),a={timeScale:timeScale.currentInterval.name,taxaFilter:[],timeFilter:h.selectedInterval,stratFilter:{name:h.stratigraphy.name,rank:h.stratigraphy.rank},authFilter:h.personFilter,zoom:t,center:[e.lat,e.lng],reconstruct:n,currentReconstruction:reconstructMap.currentReconstruction};return 0<h.taxa.length&&h.taxa.forEach(function(e){a.taxaFilter.push(e)}),a},summarize:function(e){0<e.records.length?("col"===e.records[0].oid.substr(0,3)?navMap.totalCollections=t(e.records.length):navMap.totalCollections=t(d3.sum(e.records,function(e){return e.nco})),navMap.totalOccurrences=t(d3.sum(e.records,function(e){return e.noc}))):(navMap.totalCollections=0,navMap.totalOccurrences=0),navMap.setInfoSummary()},setInfoSummary:function(){d3.select(".info").style("display","block").html("<strong>共"+navMap.totalCollections+" 个集合</strong><br>共"+navMap.totalOccurrences+" 个发现")},filters:h,totalOccurrences:void 0}}(),paleo_nav=function(){var l,c,s=window.location.origin,r="https://paleobiodb.org",o="https://paleobiodb.org",d="/data1.2",i=window.location.origin;return-1<window.location.search.indexOf("local")?(s=window.location.origin+":3000",r=window.location.origin+":3000"):-1<window.location.search.indexOf("test")?s="https://training.paleobiodb.org":"localhost"===window.location.hostname&&(s="https://paleobiodb.org"),d3.text("build/partials/prevalent.html",function(e,t){l=t}),d3.text("build/partials/prevalent_summary.html",function(e,t){c=t}),{init:function(){var e;e=1800<window.innerWidth?60:1500<window.innerWidth?75:1e3<window.innerWidth?95:110,timeScale.init("time",e,function(){navMap.init(function(){navMap.resizeSvgMap(),navMap.resize(),navMap.refresh("reset")}),reconstructMap.init(),taxaBrowser.init()}),$(".zoom-in").hammer().on("tap",function(e){e.preventDefault(),parseInt(d3.select("#map").style("height"))<1?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight-70+"px"}),map.setView(new L.LatLng(39.6395375644,116.103515625),3,{animate:!1}),navMap.refresh("reset"),map.invalidateSize()):map.zoomIn()}),$(".zoom-out").hammer().on("tap",function(e){e.preventDefault(),map.zoomOut()}),$(".rotate").hammer().on("tap",function(e){e.preventDefault(),reconstructMap.visible?paleo_nav.closeReconstructMap():paleo_nav.toggleReconstructMap()}),$(".taxa").hammer().on("tap",function(e){e.preventDefault(),e.stopPropagation(),"block"==d3.select("#taxaBrowser").style("display")?(paleo_nav.closeTaxaBrowser(),d3.select(".taxa").style("color","#000")):(paleo_nav.openTaxaBrowser(),d3.select(".taxa").style("color","#ff992c"))}),$("#taxaBrowserNavbar").hammer().on("tap",function(e){e.preventDefault(),$(".navbar-collapse").collapse("hide"),"block"===d3.select("#taxaBrowser").style("display")?paleo_nav.closeTaxaBrowser():paleo_nav.openTaxaBrowser(),$}),$(".taxaBrowserToggle").hammer().on("tap",function(e){e.preventDefault(),e.stopPropagation(),"block"===d3.select("#taxaBrowser").style("display")?paleo_nav.closeTaxaBrowser():paleo_nav.openTaxaBrowser()});var t=Mustache.compile('<p>{{nam}}{{#msp}}<small class="misspelling">  missp.</small>{{/msp}}      <small class="taxaRank">{{rank}}</small></p>');$("#taxonInput").typeahead({name:"taxaBrowser",remote:{url:s+d+"/taxa/auto.json?name=%QUERY&limit=10",filter:function(e){return e.records.forEach(function(e){e.rank=taxaBrowser.rankMap(e.rnk)}),e.records}},valueKey:"nam",minLength:3,limit:10,template:t}).on("typeahead:selected",function(e,t){taxaBrowser.goToTaxon(t.nam)}),$("input#taxonInput").keypress(function(e){if(13===e.which){var t=$("input#taxonInput").data().ttView.dropdownView.getFirstSuggestion();taxaBrowser.goToTaxon(t.datum.nam),document.activeElement.blur(),$("input#taxonInput").blur(),$("input#taxonInput").typeahead("setQuery","")}});var i={member:"Mbr",formation:"Fm",group:"Gp"};$("#universalAutocompleteInput").on("keyup",function(e){var r=$("#universalAutocompleteInput").val();if(r.length<3)return $("#universalSearchResult").html(""),void $("#universalSearchResult").css("display","none");d3.json(s+d+"/combined/auto.json?show=countries&name="+r,function(e,t){var n="";if(e)n+="<div class='autocompleteError'>Error: server did not respond</div>";else if(0==t.records.length)n+="<div class='autocompleteError'>No matching results for \""+r+'"</div>';else{var a="";t.records.map(function(e){var t=e.oid.substr(0,3);switch(t){case"int":"int"!=a&&(n+="<h4 class='autocompleteTitle'>Time Intervals</h4>",a="int"),n+="<div class='suggestion' data-nam='"+e.nam+"' data-rtype='"+t+"'>",n+="<p class='tt-suggestion'>"+e.nam+" <small class=taxaRank>"+Math.round(e.eag)+"-"+Math.round(e.lag)+" ma</small></p></div>";break;case"str":"str"!=a&&(n+="<h4 class='autocompleteTitle'>Stratigraphic Units</h4>",a="str"),n+="<div class='suggestion' data-nam='"+e.nam+"' data-rnk='"+e.rnk+"' data-rtype='"+t+"'>",n+="<p class='tt-suggestion'>"+e.nam+" "+i[e.rnk]+" <small class=taxaRank>in "+e.cc2+"</small></p></div>";break;case"prs":"prs"!=a&&(n+="<h4 class='autocompleteTitle'>Authorizers</h4>",a="prs"),n+="<div class='suggestion' data-nam='"+e.nam+"' data-oid='"+e.oid+"' data-rtype='"+t+"'>",n+="<p class='tt-suggestion'>"+e.nam+" <small class=taxaRank>"+e.ist+"</small></p></div>";break;case"txn":"txn"!=a&&(n+="<h4 class='autocompleteTitle'>Taxa</h4>",a="txn"),n+="<div class='suggestion' data-oid='"+e.oid+"' data-rtype='"+t+"'>",e.tdf?n+="<p class='tt-suggestion'>"+e.nam+" <small class=taxaRank>"+e.rnk+" in "+e.htn+"</small><br><small class=misspelling>"+e.tdf+" "+e.acn+"</small></p></div>":n+="<p class='tt-suggestion'>"+e.nam+" <small class=taxaRank>"+e.rnk+" in "+e.htn+"</small></p></div>"}})}$("#universalSearchResult").html(n),$("#universalSearchResult").css("display","block"),$(".suggestion").on("click",function(e){switch(e.preventDefault(),$("#universalSearchResult").css("display","none"),$(this).attr("data-rtype")){case"int":timeScale.goTo($(this).attr("data-nam")),navMap.filterByTime($(this).attr("data-nam")),navMap.refresh("reset");break;case"str":var t={nam:$(this).attr("data-nam"),type:i[$(this).attr("data-rnk")]};navMap.filterByStratigraphy(t);break;case"prs":var n={id:$(this).attr("data-oid"),nam:$(this).attr("data-nam")};navMap.filterByPerson(n),document.activeElement.blur();break;case"txn":navMap.filterByTaxon($(this).attr("data-oid"))}$("#universalAutocompleteInput").val("")})})});$("#universalAutocompleteInput").on("focus",function(){window.innerWidth<700&&($(".navbar-collapse").css("height",window.innerHeight-50+"px"),$(".navbar-collapse").css("max-height",window.innerHeight-50+"px"),$(".tt-dropdown-menu").css("width",$("#universalAutocompleteInput").width()+"px"))}),$("#universalAutocompleteInput").on("blur",function(){window.scrollTo(0,0),window.innerWidth<700&&($(".navbar-collapse").css("height","auto"),$(".navbar-collapse").css("max-height","340px"))}),$("#universalSearchButton").click(function(e){e.preventDefault()}),d3.select(window).on("resize",function(){timeScale.resize(),navMap.resize(),reconstructMap.resize()}),$("#binModal").on("hide.bs.modal",function(){$("#collectionLoading").hide(),$("#collectionCount").show(),$(".show-more-collections").data("offset",0),$(".show-more-collections").data("shown-collections",0),$(".show-more-collections").data("total-collections",0)}),$("#statsBox").on("show.bs.modal",function(){$(".statsContent").height(window.innerHeight-70),$(".diversityContainer").height(window.innerHeight-140),$("#diversityWait").css("display","block"),d3.select("#diversity").select("svg").remove(),$("#prevalence-container").html("");var e=map.getBounds(),t=e._southWest,n=e._northEast;parseInt(d3.select("#map").style("height"))<1&&(t.lng=-180,n.lng=180,t.lat=-90,n.lat=90);var a=navMap.parseURL(r+d+"/occs/quickdiv.json?lngmin="+t.lng.toFixed(1)+"&lngmax="+n.lng.toFixed(1)+"&latmin="+t.lat.toFixed(1)+"&latmax="+n.lat.toFixed(1)+"&count=genera&reso=stage");$(".diversityDownload").attr("href",a),$(".divMapBounds").html(t.lng.toFixed(1)+"° to "+n.lng.toFixed(1)+"° N, "+t.lat.toFixed(1)+"° to "+n.lat.toFixed(1)+"° E"),diversityPlot.plot(a,!1)}),$("#statsBox").on("hide.bs.modal",function(){void 0!==diversityPlot.currentRequest&&0<Object.keys(diversityPlot.currentRequest).length&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={})}),$("#advstatsBox").on("show.bs.modal",function(){$(".advstatsContent").height(window.innerHeight-70),$(".advdiversityContainer").height(window.innerHeight-140),$("#advdiversityWait").css("display","block"),d3.select("#advdiversity").select("svg").remove();var e=map.getBounds(),t=e._southWest,n=e._northEast;parseInt(d3.select("#map").style("height"))<1&&(t.lng=-180,n.lng=180,t.lat=-90,n.lat=90);var a=navMap.parseURL(r+d+"/occs/diversity.json?lngmin="+t.lng.toFixed(1)+"&lngmax="+n.lng.toFixed(1)+"&latmin="+t.lat.toFixed(1)+"&latmax="+n.lat.toFixed(1)+"&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val()+"&recent="+$('[name="extant"]').is(":checked"));$(".diversityDownload").attr("href",a),diversityPlot.plot(a,!0)}),$("#advstatsBox").on("hide.bs.modal",function(){void 0!==diversityPlot.currentRequest&&0<Object.keys(diversityPlot.currentRequest).length&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={})}),$("#saveBox").on("show.bs.modal",function(){$("#urlTab").hasClass("active")&&$.ajax({url:o+"/larkin/app-state",async:!1,type:"POST",data:{state:navMap.getUrl()},ContentType:"application/x-www-form-urlencoded",dataType:"json"}).success(function(e){$("#url").val(o+"/navigator/#/"+e.id),setTimeout(function(){$("#url").focus(),$("#url").select()},100)});var e=map.getBounds(),t=e._southWest,n=e._northEast;parseInt(d3.select("#map").style("height"))<1&&(t.lng=-180,n.lng=180,t.lat=-90,n.lat=90),$("#filterList").append("<li>Map extent - <small>(["+t.lat.toFixed(0)+", "+t.lng.toFixed(0)+"], ["+n.lat.toFixed(0)+", "+n.lng.toFixed(0)+"])</small></li>");for(var a in navMap.filters.exist)if(navMap.filters.exist.hasOwnProperty(a)&&1==navMap.filters.exist[a]){switch(a){case"selectedInterval":$("#filterList").append("<li>Interval - "+navMap.filters.selectedInterval.nam+"</li>");break;case"personFilter":$("#filterList").append("<li>Contributor - "+navMap.filters.personFilter.name+"</li>");break;case"taxon":navMap.filters.taxa.forEach(function(e){$("#filterList").append("<li>Taxon - "+e.name+"</li>")})}1}var r=s+d+"/occs/list.json?lngmin="+t.lng+"&lngmax="+n.lng+"&latmin="+t.lat+"&latmax="+n.lat+"&limit=0&rowcount";r=navMap.parseURL(r),d3.json(r,function(e,t){var n=.67*t.records_found;n=n<1024?n.toFixed(0)+"KB":n<1024e3?(n/1024).toFixed(0)+"MB":(n/1024e3).toFixed(0)+"GB",d3.select("#occsLabel").html("Occurrences <small><i>(About "+n+")</i></small>")})}),$("#saveBox").on("hide.bs.modal",function(){$("#filterList").html(""),d3.select("#occsLabel").html("Occurrences "),$("#appUrl").val(""),$("#apiUrl").val(""),d3.select("#downloadCount").style("display","none"),d3.select("#diversity").select("svg").remove()}),$("#getAppUrl").on("click",function(){$.ajax({url:o+"/larkin/app-state",async:!1,type:"POST",data:{state:navMap.getUrl()},ContentType:"application/x-www-form-urlencoded",dataType:"json"}).success(function(e){$("#appUrl").val(o+"/navigator/#/"+e.id),setTimeout(function(){$("#appUrl").focus(),$("#appUrl").select()},100)})}),$("#getApiUrl").on("click",function(){var e=navMap.getApiUrl();$("#apiUrl").val(e),setTimeout(function(){$("#apiUrl").focus(),$("#apiUrl").select()},100)}),$("#taxaForm").submit(function(){return navMap.filterByTaxon(),!1}),$(".helpModalClose").on("click",function(){$("#helpModal").modal("hide")}),$("#goToApp").on("click",function(){$("#helpModal").modal("hide")}),$("#trilobita").on("click",function(e){e.preventDefault(),paleo_nav.closeReconstructMap();navMap.restoreState({authFilter:{id:"",name:""},center:[30.3539163,113.24707],currentReconstruction:"",reconstruct:"none",taxaFilter:[{id:19100,nam:"Trilobita"}],timeFilter:{nam:"Cambrian",oid:22,mid:513},timeScale:"Cambrian",zoom:5}),$("#helpModal").modal("hide")}),$("#dinosauria").on("click",function(e){e.preventDefault(),paleo_nav.closeReconstructMap();navMap.restoreState({authFilter:{id:"",name:""},center:[40.5305,-109.5117],currentReconstruction:"",reconstruct:"none",taxaFilter:[{id:19968,nam:"Dinosauria"}],timeFilter:{nam:"Jurassic",oid:15,mid:173},timeScale:"Jurassic",zoom:5}),$("#helpModal").modal("hide")}),$("#plantae").on("click",function(e){e.preventDefault();navMap.restoreState({authFilter:{id:"",name:""},center:"",currentReconstruction:{nam:"Permian",col:"#F04028",mid:275,oid:17,taxon:"Plantae",person:""},taxaFilter:[],reconstruct:"block",taxaFilter:[{id:151418,nam:"Plantae"}],timeFilter:{nam:"Permian",oid:17,mid:275},timeScale:"Permian",zoom:""}),$("#helpModal").modal("hide")})},getPrevalence:function(e){$(".prevalence-summary").html(""),"undefined"!=typeof currentPrevRequest&&0<Object.keys(currentPrevRequest).length&&(currentPrevRequest.abort(),currentPrevRequest={});var t=map.getBounds(),n=t._southWest,a=t._northEast;parseInt(d3.select("#map").style("height"))<1&&(n.lng=-180,a.lng=180,n.lat=-90,a.lat=90);var r=navMap.parseURL(i+"/data/prevalence.json?limit=50&lngmin="+n.lng.toFixed(1)+"&lngmax="+a.lng.toFixed(1)+"&latmin="+n.lat.toFixed(1)+"&latmax="+a.lat.toFixed(1));currentPrevRequest=d3.json(r,function(e,t){var a=d3.scale.linear().domain([d3.min(t.records,function(e){return e.noc}),d3.max(t.records,function(e){return e.noc})]).range([40,80]),r=t.records.map(function(e){return e.noc}).reduce(function(e,t){return e+t},0);t.records.forEach(function(e){var t=e.nam.split(" ");e.display_name=t[0]+(1<t.length?"*":""),e.data_url=paleo_nav.dataUrl,e.height=a(e.noc);var n=parseInt(e.noc/r*100);e.percentage=n<1?"< 1":n});var n=t.records.filter(function(e,t){if(t<11)return e}),i=t.records.filter(function(e,t){if(700<window.innerWidth){var n=window.innerHeight-parseInt(d3.select("#time").select("svg").style("height"));if(t<Math.floor(n/80))return e}else if(t<Math.floor(window.innerHeight/80))return e});i.forEach(function(e){e.display_text=e.display_name+(17<e.display_name.length?"":" "+e.percentage+"%")});var s=Mustache.render(c,{records:i});$(".prevalence-summary").html(s);var o=Mustache.render(l,{records:n});$(".prevalence-container").html(o),$(".prevalent-summary-taxon").click(function(e){var t=$(this).data("name").replace(" (other)","").replace(" (unclassified)","").replace("*","");navMap.filterByTaxon(t)})})},prelaunch:function(){1<window.location.hash.substr(2).length?navMap.restoreState():paleo_nav.launch()},launch:function(){d3.select("#graphicRow").style("visibility","visible"),d3.select("#waiting").style("display","none"),navMap.resizeSvgMap(),setTimeout(navMap.resize,500),this.getPrevalence(),localStorage.pbdb||700<window.innerWidth&&($("#helpModal").modal("show"),localStorage.pbdb=!0)},showLoading:function(){d3.select("#loading").style("display","block")},hideLoading:function(){d3.select("#loading").style("display","none")},untoggleTaxa:function(){d3.select(".taxaToggler").style("display","none"),d3.select(".taxa").style("color","")},untoggleUser:function(){d3.select(".userToggler").style("display","none"),d3.select(".userFilter").style("color","")},openTaxaBrowser:function(){d3.select("#graphics").attr("class","col-sm-9"),d3.select("#taxaBrowser").style("display","block"),d3.select("#taxaBrowserToggle").html('<i class="fa fa-angle-double-left" style="margin-right:5px;"></i>Collapse taxa browser'),d3.select(".taxaToggler").style("display","none"),timeScale.resize(),reconstructMap.resize(),navMap.resize()},closeTaxaBrowser:function(){d3.select("#graphics").attr("class","col-sm-12"),d3.select("#taxaBrowser").style("display","none"),d3.select("#taxaBrowserToggle").html('Expand taxa browser<i class="fa fa-angle-double-right" style="margin-left:5px;"></i>'),d3.select(".taxa").style("color","#000"),timeScale.resize(),reconstructMap.resize(),navMap.resize(),navMap.resize()},toggleReconstructMap:function(){if(paleo_nav.untoggleTaxa(),paleo_nav.untoggleUser(),paleo_nav.closeTaxaBrowser(),reconstructMap.visible=!0,d3.select(".rotate").style("box-shadow","inset 3px 0 0 #ff992c").style("color","#ff992c"),1<parseInt(d3.select("#map").style("height"))&&d3.select("#map").style("display","none"),d3.select("#svgMap").style("display","none"),d3.select("#reconstructMap").style("display","block"),reconstructMap.resize(),$(".zoom-in").hammer().off("tap").css("color","#ccc"),$(".zoom-out").hammer().off("tap").css("color","#ccc"),navMap.filters.exist.selectedInterval)reconstructMap.rotate(navMap.filters.selectedInterval);else if(interval.nam===reconstructMap.currentReconstruction.name&&navMap.filters.personFilter.name===reconstructMap.currentReconstruction.person&&navMap.filters.stratigraphy.name===reconstructMap.currentReconstruction.stratigraphy){var e=0;if(navMap.filters.taxa.length===reconstructMap.currentReconstruction.taxa.length&&(navMap.filters.taxa.forEach(function(t){var n=!1;reconstructMap.currentReconstruction.taxa.forEach(function(e){t.name===e.name&&(n=!0)}),n||(e+=1)}),0===e))return}else reconstructMap.currentReconstruction.name.length,alert("Please click a time interval below to build a reconstruction map"),d3.select(".info").html("Click a time interval to reconstruct collections and plates").style("display","block")},closeReconstructMap:function(){navMap.refresh("reset"),reconstructMap.visible=!1,d3.select("#reconstructMap").style("display","none"),timeScale.unhighlight(),$(".zoom-in").hammer().on("tap",function(e){e.preventDefault(),parseInt(d3.select("#map").style("height"))<1?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight-70+"px"}),navMap.refresh("reset"),map.invalidateSize()):map.zoomIn()}).css("color","#000"),$(".zoom-out").hammer().on("tap",function(e){e.preventDefault(),map.zoomOut()}).css("color","#000"),d3.select(".prevalence-row").style("display","block"),paleo_nav.getPrevalence(),d3.select("#selectedInterval").select("button").style("display","block"),d3.select(".rotate").style("box-shadow","").style("color","#000"),d3.select(".time").style("color","#000"),parseInt(d3.select("#map").style("height"))<1?d3.select("#svgMap").style("display","block"):d3.select("#map").style("display","block"),navMap.resize(),map.invalidateSize()},dataUrl:s,testUrl:r,stateUrl:o,dataService:d,siteUrl:i}}();$(document).ready(function(){paleo_nav.init()}),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.selection.prototype.dblTap=function(t){var n=0;return this.each(function(){d3.select(this).on("touchstart",function(e){if(d3.event.timeStamp-n<2e3)return t(e);n=d3.event.timeStamp})})};var timeScale=function(){var data={id:0,color:"#000000",name:"地质年代表",e_name:"Geologic Time",children:[]},interval_hash={0:data},currentInterval,dragStart,transformStart;function clickcancel(){var s=d3.dispatch("click","dblclick");return d3.rebind(function(e){var r,i=null;e.on("mousedown",function(e){r=d3.mouse(document.body),new Date}),e.on("mouseup",function(e){var t,n,a;n=r,a=d3.mouse(document.body),5<Math.sqrt(Math.pow(n[0]-a[0],2),Math.pow(n[1]-a[1],2))||(i?(window.clearTimeout(i),i=null,s.dblclick(d3.event)):i=window.setTimeout((t=d3.event,function(){s.click(t),i=null}),300))})},s,"on")}function init(e,p,h){var f=d3.scale.linear().range([0,955]),m=d3.scale.linear().range([0,p]),t=.01,g=d3.behavior.drag().origin(function(){d3.select(".timeScale g");return{x:-t,y:0}}).on("dragstart",function(){dragStart=[d3.event.sourceEvent.pageX,d3.event.sourceEvent.pageY],transformStart=d3.transform(d3.select(".timeScale").select("g").attr("transform")).translate,d3.event.sourceEvent.stopPropagation()}).on("drag",function(){var e=[d3.event.sourceEvent.pageX,d3.event.sourceEvent.pageY];t=dragStart[0]-e[0],d3.select(".timeScale").select("g").attr("transform",function(){return"translate("+[parseInt(transformStart[0]+-t),0]+")scale("+parseInt(d3.select(".timeScale").style("width"))/961+")"})});d3.select("#"+e).attr("class","timeScale");var v=d3.select("#"+e).append("svg:svg").attr("width",960).attr("height",p).append("g"),y=v.append("g").attr("id","tickBar").attr("transform","translate(0,"+(p+15)+")");d3.json(paleo_nav.siteUrl+"/data/intervals_list.json?scale=1&order=age.desc&max_ma=4000",function(e,t){for(var n=0;n<t.records.length;n++){var a={id:t.records[n].oid.replace("int:",""),pid:t.records[n].pid?t.records[n].pid.replace("int:",""):0,level:t.records[n].lvl,color:t.records[n].col,name:t.records[n].nam,abbr:t.records[n].abr||t.records[n].nam.charAt(0),early_age:t.records[n].eag,late_age:t.records[n].lag,mid:parseInt((t.records[n].eag+t.records[n].lag)/2),total:t.records[n].eag-t.records[n].lag,children:[]};interval_hash[a.id]=a,interval_hash[a.pid].children.push(a)}var r=d3.layout.partition().sort(function(e){d3.ascending(e)}).value(function(e){return e.total}),i=clickcancel();v.append("g").attr("id","rectGroup").selectAll("rect").data(r.nodes(data)).enter().append("svg:rect").attr("x",function(e){return f(e.x)}).attr("y",function(e){return m(e.y)}).attr("width",function(e){return f(e.dx)}).attr("height",function(e){return m(e.dy)}).attr("fill",function(e){return e.color||"#000000"}).attr("id",function(e){return"t"+e.id}).style("opacity",.83).call(g).call(i).dblTap(function(e){setTimeout(goTo(e),500)}).append("svg:title").text(function(e){return e.name}),i.on("dblclick",function(e){goTo(e.target.__data__)}),i.on("click",function(e){mapFilter(e.target.__data__)});var s=y.selectAll("rect").data(r.nodes(data)).enter().append("g").attr("class",function(e){return"tickGroup s"+(void 0===e.level?0:e.level)}).attr("transform",function(e){return"translate("+f(e.x)+", -20)"});s.append("line").attr("x1",0).attr("y1",7.5).attr("x2",0).attr("y2",12).style("stroke-width","0.05em"),s.append("text").attr("x",0).attr("y",function(){return 1.05*(p/6*.55+12)}).style("text-anchor",function(e){return.0117===e.early_age?"end":"middle"}).style("font-size",function(){return p/6*.55}).style("fill","#777").text(function(e){return e.early_age});var o=y.append("g").data([{x:1,y:0}]).attr("class","tickGroup s1 s2 s3 s4 s5").attr("transform","translate(955, -20)");o.append("line").attr("x1",0).attr("y1",7.5).attr("x2",0).attr("y2",12).style("stroke-width","0.05em"),o.append("text").attr("x",0).attr("y",function(){return 1.05*(p/6*.55+12)}).attr("id","now").style("text-anchor","end").style("font-size",function(){return p/6*.55}).style("fill","#777").text("0");var l=v.append("g").attr("id","textGroup"),c={0:.61,1:.89,2:.72,3:.61,4:.55,5:.55},d=clickcancel();l.selectAll("fullName").data(r.nodes(data)).enter().append("svg:text").text(function(e){return e.name}).attr("x",1).attr("y",function(e){return m(e.y)+.127*p}).attr("width",function(){return this.getComputedTextLength()}).attr("height",function(e){return m(e.dy)}).attr("class",function(e){return"fullName level"+(void 0===e.level?0:e.level)}).attr("id",function(e){return"l"+e.id}).attr("x",function(e){return labelX(e)}).style("font-size",function(e){return void 0===e.level?p/6*c[0]+"px":p/6*c[e.level]+"px"}).call(g).call(d).dblTap(function(e){setTimeout(goTo(e),500)}).append("svg:title").text(function(e){return e.name}),d.on("dblclick",function(e){goTo(e.target.__data__)}),d.on("click",function(e){mapFilter(e.target.__data__)});var u=clickcancel();l.selectAll("abbrevs").data(r.nodes(data)).enter().append("svg:text").attr("x",1).attr("y",function(e){return m(e.y)+.127*p}).attr("width",30).attr("height",function(e){return m(e.dy)}).text(function(e){return e.abbr||e.name.charAt(0)}).attr("class",function(e){return"abbr level"+(void 0===e.level?0:e.level)}).attr("id",function(e){return"a"+e.id}).attr("x",function(e){return labelAbbrX(e)}).style("font-size",function(e){return void 0===e.level?p/6*c[0]+"px":p/6*c[e.level]+"px"}).call(u).dblTap(function(e){setTimeout(goTo(e),500)}).append("svg:title").text(function(e){return e.name}),u.on("dblclick",function(e){goTo(e.target.__data__)}),u.on("click",function(e){mapFilter(e.target.__data__)}),h(),goTo(interval_hash[0]),d3.select(".abbr.levelundefined").remove(),goTo(interval_hash[751])}),resize()}function labelLevels(d){if(d3.select("#l"+d.id).attr("x",430),void 0!==d.parent){for(var depth=d.depth,loc="d.parent",i=0;i<depth;i++){var parent=eval(loc).name;d3.selectAll(".abbr").filter(function(e){return e.name===parent}).attr("x",430),d3.selectAll(".fullName").filter(function(e){return e.name===parent}).attr("x",430),loc+=".parent"}d3.selectAll(".abbr").filter(function(e){return e.name===parent}).attr("x",430),d3.selectAll(".fullName").filter(function(e){return e.name===parent}).attr("x",430),"hidden"===d3.select("#graphicRow").style("visibility")&&paleo_nav.prelaunch()}}function labelAbbrX(e){var t,n=parseFloat(d3.select("rect#t"+e.id).attr("width")),a=parseFloat(d3.select("rect#t"+e.id).attr("x"));try{t=d3.select("#a"+e.id).node().getComputedTextLength()}catch(e){t=11}return n-8<t&&d3.select("#a"+e.id).style("display","none"),a+(n-t)/2}function labelX(e){var t,n=parseFloat(d3.select("rect#t"+e.id).attr("width")),a=parseFloat(d3.select("rect#t"+e.id).attr("x"));try{t=d3.select("#l"+e.id).node().getComputedTextLength()}catch(e){t=25}return n-8<t?d3.select("#l"+e.id).style("display","none"):d3.select("#a"+e.id).style("display","none"),a+(n-t)/2}function labelY(e){var t=parseFloat(d3.select("rect#t"+e.id).attr("height")),n=parseFloat(d3.select("rect#t"+e.id).attr("y")),a=d3.select("#l"+e.id).node().getBBox().height;parseInt(d3.select(".timeScale").style("width"));return.8*n+(t-a)/2+8}function labelAbbrY(e){var t=parseFloat(d3.select("rect#t"+e.id).attr("height")),n=parseFloat(d3.select("rect#t"+e.id).attr("y")),a=d3.select("#l"+e.id).node().getBBox().height;parseInt(d3.select(".timeScale").style("width"));return.8*n+(t-a)/2}function mapFilter(e){if(e.id!==navMap.filters.selectedInterval.oid)if(highlight(e.name),navMap.filters.selectedInterval.nam=e.name,navMap.filters.selectedInterval.mid=e.mid,navMap.filters.selectedInterval.col=e.color,navMap.filters.selectedInterval.oid=e.id,navMap.filters.exist.selectedInterval=!0,navMap.updateFilterList("selectedInterval"),reconstructMap.visible){var t=parseInt((e.early_age+e.late_age)/2);if(e.depth<3)return alert("Please select a period or finer interval");if(550<t)return alert("Please select an interval younger than 600 MA");navMap.refresh("reset"),reconstructMap.rotate(e)}else navMap.refresh("reset")}function goTo(t,e){if("string"==typeof t)t=(t=d3.selectAll("rect").filter(function(e){return e.name===t}))[0][0].__data__;else if(t.children){if(t.children.length<1)t=t.parent}else t=t;var n="undefined"!=(timeScale.currentInterval=t).depth?parseInt(t.depth)+1:1;d3.selectAll(".scale").style("display","none"),d3.selectAll(".tickGroup").style("display","none"),d3.selectAll(".s"+n).style("display","block"),d3.select(".timeScale g").attr("transform",function(){return"scale("+parseInt(d3.select(".timeScale").style("width"))/961+")"});var a=0,r=d3.scale.linear().range([5,955]);r.domain([t.x,t.x+t.dx]),d3.selectAll(".fullName").style("fill","rgba(0,0,0,0)").style("display","block"),d3.selectAll(".abbr").style("fill","rgba(0,0,0,0)").style("display","block"),d3.selectAll(".tickGroup").transition().duration(750).attr("transform",function(e){return d3.select(this).selectAll("text").style("text-anchor","middle"),5==r(e.x)?d3.select(this).select("text").style("text-anchor","start"):955==r(e.x)&&d3.select(this).select("text").style("text-anchor","end"),"translate("+r(e.x)+", -20)"}),d3.selectAll("rect").transition().duration(750).each(function(){++a}).attr("x",function(e){return r(e.x)}).attr("width",function(e){return r(e.x+e.dx)-r(e.x)}).each("end",function(){--a||labelTrans(t)})}function labelTrans(e){var t=0,n=d3.scale.linear().range([0,955]),a=d3.scale.linear().range([0,120]);n.domain([e.x,e.x+e.dx]),d3.selectAll(".fullName").transition().duration(10).each(function(){++t}).attr("x",function(e){return labelX(e)}).attr("height",function(e){return a(e.y+e.dy)-a(e.y)}).each("end",function(){--t||labelLevels(e)}),d3.selectAll(".abbr").transition().duration(300).each(function(){++t}).attr("x",function(e){return labelAbbrX(e)}).attr("height",function(e){return a(e.y+e.dy)-a(e.y)}).each("end",function(){--t?(d3.selectAll(".fullName").style("fill","#333"),d3.selectAll(".abbr").style("fill","#333")):(labelLevels(e),d3.select("#l0").style("fill","#fff"))}),resize()}function highlight(t){if(unhighlight(),t.cxi){var e=t.cxi;d3.selectAll("rect#t"+t.cxi).style("stroke","#000").moveToFront(),d3.selectAll("#l"+t.cxi).moveToFront()}else if("string"==typeof t){e=(e=d3.selectAll("rect").filter(function(e){return e.name===t}).attr("id")).replace("t","")}else{e=(e=d3.select(t).attr("id")).replace("p","")}d3.selectAll("rect#t"+e).style("stroke","#000").moveToFront(),d3.selectAll("#l"+e).moveToFront(),d3.selectAll(".abbr").moveToFront()}function unhighlight(e){d3.selectAll("rect").style("stroke","#fff")}function resize(){d3.select(".timeScale g").attr("transform",function(){return"scale("+parseInt(d3.select("#graphics").style("width"))/961+")"});var t,n=d3.select(".timeScale").select("svg");try{t=n.node().getBBox()}catch(e){t={x:n.node().clientLeft,y:n.node().clientTop,width:n.node().clientWidth,height:n.node().clientHeight}}d3.select(".timeScale svg").style("width",function(){return parseInt(d3.select("#graphics").style("width"))-1+"px"}),d3.select(".timeScale svg").style("height",function(){return t.height+5+"px"})}return{init:init,goTo:goTo,highlight:highlight,unhighlight:unhighlight,resize:resize,interval_hash:interval_hash,currentInterval:currentInterval}}(),reconstructMap=function(){var o,r=!1,i=d3.geo.hammer().scale(165).translate([480,250]).rotate([1e-6,0]).precision(.3),l=d3.geo.path().projection(i);return{init:function(){var e=d3.select("#reconstructMap").append("svg").attr("height",500).attr("width",960).append("g").attr("id","reconstructGroup");e.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",l),e.append("use").attr("class","stroke").attr("xlink:href","#sphere"),e.append("use").attr("class","fill").attr("xlink:href","#sphere"),$("#mapSwitch").on("click",function(e){e.preventDefault(),paleo_nav.closeReconstructMap()}),d3.json("build/js/plates/Holocene.json",function(e,t){var n=d3.select("#reconstructGroup").append("g").attr("id","reconstructContent");n.selectAll(".plateLines").data(topojson.feature(t,t.objects.Holocene).features).enter().append("path").attr("class","plates").attr("d",l),d3.json("build/js/coastlines/Holocene.json",function(e,t){n.selectAll(".coastlines").data(topojson.feature(t,t.objects.Holocene).features).enter().append("path").attr("class","coastlines").attr("d",l)})})},rotate:function(i){var n=i.nam?i.nam:i.name;if(n===reconstructMap.currentReconstruction.name&&navMap.filters.personFilter.name===reconstructMap.currentReconstruction.person&&navMap.filters.stratigraphy.name===reconstructMap.currentReconstruction.stratigraphy){var e=0;if(navMap.filters.taxa.length===reconstructMap.currentReconstruction.taxa.length&&(navMap.filters.taxa.forEach(function(t){var n=!1;reconstructMap.currentReconstruction.taxa.forEach(function(e){t.name===e.name&&(n=!0)}),n||(e+=1)}),0===e))return void d3.select("#selectedInterval").select("button").style("display","none")}r=!0,reconstructMap.reset(),paleo_nav.showLoading(),d3.select("#interval").text(n),d3.select("#rotationInterval").html(n),d3.select("#age").text("("+i.mid+" Ma)"),d3.select("#rotationYear").html(i.mid+" Ma"),i.mid<201?d3.select("#rotationReference").html("<p>Seton, M., R.D. Müller, S. Zahirovic, C. Gaina, T.H. Torsvik, G. Shephard, A. Talsma, M. Gurnis, M. Turner, S. Maus, M. Chandler. 2012. Global continental and ocean basin reconstructions since 200 Ma. <i>Earth-Science Reviews </i>113:212-270.</p>"):d3.select("#rotationReference").html("<p>Wright, N. S. Zahirovic, R.D. Müller, M. Seton. 2013. Towards community-driven paleogeographic reconstructions: intergrating open-access paleogeographic and paleobiology data with plate tectonics. <i>Biogeosciences </i>10:1529-1541.</p>"),d3.select("#selectedInterval").select("button").style("display","none");var a=d3.select("#reconstructGroup").append("g").attr("id","reconstructContent"),s=n.split(" ").join("_");d3.json("build/js/collections/"+s+".json",function(e,r){d3.json("build/js/plates/"+s+".json",function(e,t){a.selectAll(".plateLines").data(topojson.feature(t,t.objects[s]).features).enter().append("path").attr("class","plates").attr("d",l),timeScale.highlight(n),d3.json("build/js/coastlines/"+s+".json",function(e,t){a.selectAll(".coastlines").data(topojson.feature(t,t.objects[s]).features).enter().append("path").attr("class","coastlines").attr("d",l)}),1<parseInt(d3.select("#map").style("height"))&&d3.select("#map").style("display","none"),d3.select("#svgMap").style("display","none"),d3.select("#reconstructMap").style("display","block"),reconstructMap.resize(),d3.select(".info").html("").style("display","none"),d3.json("build/js/rotatedIntervals/"+s+".json",function(e,t){var n=Object.keys(t.objects)[0];if(o=topojson.feature(t,t.objects[n]),navMap.filters.exist.taxon||navMap.filters.exist.personFilter||navMap.filters.exist.stratigraphy){var a=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/summary.json?lngmin=-180&lngmax=180&latmin=-90&latmax=90&level=3&limit=99999";a=navMap.parseURL(a),d3.json(a,function(e,t){var n=t.records.map(function(e){return e.oid=e.oid.replace("clu:",""),e}),a=[];n.forEach(function(t){o.features.forEach(function(e){t.oid==e.properties.NAME&&a.push(e)})}),a.forEach(function(e){for(var t=0;t<r.records.length;t++)parseInt(e.properties.NAME)==r.records[t].oid&&(e.properties.nco=r.records[t].nco,e.properties.noc=r.records[t].noc,e.properties.oid=r.records[t].oid)}),reconstructMap.addToMap(a,i),navMap.summarize(t)})}else o.features.forEach(function(e){for(var t=0;t<r.records.length;t++)parseInt(e.properties.NAME)==r.records[t].oid&&(e.properties.nco=r.records[t].nco,e.properties.noc=r.records[t].noc,e.properties.oid=r.records[t].oid)}),reconstructMap.addToMap(o.features,i),navMap.summarize(r)})})})},addToMap:function(e,t){var n=d3.select("#reconstructContent"),a=d3.scale.linear().domain([1,4240]).range([4,15]);n.selectAll("circle").data(e).enter().append("circle").attr("class","collection").style("fill",function(){return t.col?t.col:t.color}).attr("r",function(e){return.7*a(e.properties.nco)}).attr("cx",function(e){return i(e.geometry.coordinates)[0]}).attr("cy",function(e){return i(e.geometry.coordinates)[1]}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.properties.nco+" collections</strong><br>"+e.properties.noc+" occurrences").style("display","block")}).on("click",function(e){d3.select(".info").html("<strong>"+e.properties.nco+" collections</strong><br>"+e.properties.noc+" occurrences").style("display","block"),navMap.openBinModal(e)}).on("mouseout",function(e){d3.select(".info").html("").style("display","none")}),r=!1,paleo_nav.hideLoading(),reconstructMap.currentReconstruction={name:t.nam?t.nam:t.name,color:t.col,mid:t.mid,id:t.oid,taxa:[],person:"",stratigraphy:""},navMap.filters.exist.taxon&&navMap.filters.taxa.forEach(function(e){reconstructMap.currentReconstruction.taxa.push({name:e.name})}),navMap.filters.exist.personFilter&&(reconstructMap.currentReconstruction.person=navMap.filters.personFilter.name),navMap.filters.exist.stratigraphy&&(reconstructMap.currentReconstruction.stratigraphy=navMap.filters.stratigraphy.name)},addBBox:function(e){d3.selectAll(".rotatedBBox").remove();var t=map.getBounds(),n=t._southWest,a=t.getSouthEast(),r=t._northEast,i=t.getNorthWest();map.getZoom();n.lng=n.lng<-180?-180:n.lng,n.lat=n.lat<-90?-90:n.lat,r.lng=180<r.lng?180:r.lng,r.lat=90<r.lat?90:r.lat;var s=[{oid:"a",lat:n.lat,lng:n.lng},{oid:"b",lat:i.lat,lng:i.lng},{oid:"c",lat:r.lat,lng:r.lng},{oid:"d",lat:a.lat,lng:a.lng}];s=navMap.buildWKT(s);var o="&time="+e+'&points="'+encodeURI(s)+'"&output=geojson';d3.xhr("http://gplates.gps.caltech.edu:8080/recon_points/").header("Content-type","application/x-www-form-urlencoded").post(o,function(e,t){if(e)return console.log("Gplates error - ",e),alert("GPlates could not complete the request");var n=JSON.parse(t.response);n.features.sort(function(e,t){return e.properties.NAME<t.properties.NAME?-1:e.properties.NAME>t.properties.NAME?1:0});var a={type:"FeatureCollection",features:[{geometry:{type:"Polygon",coordinates:[[n.features[0].geometry.coordinates,n.features[1].geometry.coordinates,n.features[2].geometry.coordinates,n.features[3].geometry.coordinates,n.features[3].geometry.coordinates]]},type:"Feature",properties:{}}]};d3.select("#reconstructContent").selectAll(".bbox").data(a.features).enter().append("path").attr("class","rotatedBBox").attr("fill","none").attr("stroke","#ccc").attr("stroke-dasharray","5,5").attr("stroke-width",2).attr("opacity",1).attr("d",l)})},resize:function(){var a=parseInt(d3.select("#graphics").style("width")),r=d3.select("#reconstructMap").select("svg");d3.select("#reconstructGroup").attr("transform",function(){var t;try{t=r.node().getBBox()}catch(e){t={x:r.node().clientLeft,y:r.node().clientTop,width:r.node().clientWidth,height:r.node().clientHeight}}window.innerHeight;if(a>t.width+50)return"scale("+window.innerHeight/800+")translate("+(a-t.width)/2+",0)";var e=.7*window.innerHeight-70,n=a/970*500;return"scale("+a/970+")translate(0,"+(0<(e-n)/2?(e-n)/2:0)+")"}),d3.select("#reconstructMap").select("svg").style("height",function(e){if("hidden"===d3.select(".timeScale").style("visibility"))return window.innerHeight-70+"px";var t=15<$("#time").height()?$("#time").height():window.innerHeight/5.6;return window.innerHeight-t-70+"px"}).style("width",function(e){return a-15+"px"}),d3.select("#reconstructMapRefContainer").style("height",function(){return d3.select("#svgMap").style("height")})},reset:function(){d3.select("#reconstructContent").remove(),d3.select("#interval").html(""),d3.select("#age").html("")},currentReconstruction:{name:"",taxa:[],person:""},reconstructing:r,visible:!1}}(),taxaBrowser=function(){var a=[];function t(e){if(!e)e=$("#taxonInput").val();var t;t=e.match(/^txn:|^var:/)?"id="+e:"name="+e,0<e.length&&d3.json(paleo_nav.siteUrl+"/data/list.json?status=all&"+t,function(e,t){if(e)alert("Error retrieving from list.json - ",e),paleo_nav.hideLoading();else{if(!(0<t.records.length))return alert("No taxa with this name found");paleo_nav.untoggleTaxa(),d3.select(".taxonTitle").html(t.records[0].nam+" ("+r(t.records[0].rnk)+")<i class='fa fa-plus-square'></i>").attr("id",function(){return t.records[0].nam}),$(".taxonTitle").off("click"),$(".taxonTitle").click(function(e){e.preventDefault(),navMap.filterByTaxon($(".taxonTitle").attr("id"),!0)}),n=t.records[0],d3.json(paleo_nav.siteUrl+"/data/single.json?id="+n.oid+"&show=attr,nav,size",function(e,t){return e?(paleo_nav.hideLoading(),alert("Error retrieving from single.json - ",e)):0<t.records.length?(d3.select(".taxonAttr").html(t.records[0].att),function(e){var n=[],t=0;e.kgt&&e.kgn&&e.kgn!=e.oid&&(e.kgt.rnk="kingdom",n.push(e.kgt),t=e.kgn),e.phl&&e.phn&&e.phn!=e.oid&&(e.pht.rnk="phylum",n.push(e.pht),t=e.phn),e.cll&&e.cln&&e.cln!=e.oid&&(e.clt.rnk="class",n.push(e.clt),t=e.cln),e.odl&&e.odn&&e.odn!=e.oid&&(e.odt.rnk="order",n.push(e.odt),t=e.odn),e.fml&&e.fmn&&e.fmn!=e.oid&&(e.fmt.rnk="family",n.push(e.fmt),t=e.fmn),e.prt&&e.par!=t&&n.push(e.prt);var a=d3.select("#focalTaxonParents");a.selectAll("tr").remove(),a.selectAll(".rows").data(n).enter().append("tr").append("td").append("a").attr("id",function(e){return e.nam}).attr("href","#").html(function(e){return e.nam+" ("+e.rnk+")"}).attr("class",function(e,t){return t===n.length-1?0===e.ext?"immediateParent extinct parents":"immediateParent parents":0===e.ext?"extinct parents":"parents"}),i(e)}(t.records[0]),void function(e){a=[],e.chl&&5<e.rnk&&(0===e.chl.length||!e.gns||e.chl.length!=e.gnc)&&a.push({section:"immediate subtaxa",size:e.chl.length,rank:"immediate",offset:0,order:"size.desc",taxa:e.chl}),e.phs&&a.push({section:"phyla",size:e.phs.length,rank:20,offset:0,max:10,order:"size.desc",taxa:e.phs}),e.cls&&a.push({section:"classes",size:e.cls.length,rank:17,offset:0,max:10,order:"size.desc",taxa:e.cls}),e.ods&&a.push({section:"orders",size:e.ods.length,rank:13,offset:0,max:10,order:"size.desc",taxa:e.ods}),e.fms&&a.push({section:"families",size:e.fms.length,rank:9,offset:0,max:10,order:"size.desc",taxa:e.fms}),e.gns&&a.push({section:"genera",size:e.gns.length,rank:5,offset:0,max:10,order:"size.desc",taxa:e.gns}),e.sgs&&0<e.sgs.length&&a.push({section:"subgenera",size:e.sgs.length,rank:4,offset:0,max:10,order:"size.desc",taxa:e.sgs}),e.sps&&0<e.sps.length&&a.push({section:"species",size:e.sps.length,rank:3,offset:0,max:10,order:"size.desc",taxa:e.sps}),e.sss&&0<e.sss.length&&a.push({section:"subspecies",size:e.sss.length,rank:2,offset:0,max:10,order:"size.desc",taxa:e.sss});var t=d3.select("#focal_taxon_children");t.selectAll("tr").remove(),t.selectAll(".rows").data(a).enter().append("tr").append("td").append("a").attr("id",function(e){return"t"+e.rank}).attr("class","children").attr("href","#").html(function(e){return e.size+" "+e.section}),i(e)}(t.records[0])):alert("No taxon details found - browser")}),$("#taxonInput").val(""),$("#taxaInput").val("")}var n})}function r(e){return{25:"unranked",23:"kingdom",22:"subkingdom",21:"superphylum",20:"phylum",19:"subphylum",18:"superclass",17:"class",16:"subclass",15:"infraclass",14:"superorder",13:"order",12:"suborder",11:"infraorder",10:"superfamily",9:"family",8:"subfamily",7:"tribe",6:"subtribe",5:"genus",4:"subgenus",3:"species",2:"subspecies"}[e]}function i(n){$(".parents").off("click"),$(".parents").click(function(e){e.preventDefault(),t(e.target.id)}),$(".childTaxa").off("click"),$(".childTaxa").click(function(e){e.preventDefault(),$("#subtaxaModal").modal("hide"),$("#taxaFilterInput").val(""),t(e.target.id)}),$(".children").off("click"),$(".children").click(function(e){if(e.preventDefault(),"immediate"===e.target.id.substr(1)){d3.select("#subtaxa").selectAll("li").remove(),d3.select("#subtaxa").selectAll("br").remove();var t=navMap.getIndex(a,"immediate","rank");a[t].taxa.sort(function(e,t){return e.siz>t.siz?-1:e.siz<t.siz?1:0}),a[t].taxa.forEach(function(e){var t=0===e.ext?"extinct childTaxa":"childTaxa";$("#subtaxa").append("<li><a href='#' class='"+t+"' id='"+e.nam+"'>"+e.nam+" ("+e.siz+") </a></li>")}),$("#subtaxa").append("<br>"),i(n),$("#subtaxaModal").modal()}})}return{init:function(){$("#taxaSearch").submit(function(){return t(),!1})},goToTaxon:t,rankMap:r,filter:function(e){var t=$(e).val();t=t.charAt(0).toUpperCase()+t.slice(1),$("#subtaxa > li:not(:contains("+t+"))").hide(),$("#subtaxa > li:contains("+t+")").show()}}}(),diversityPlot=function(){var M={top:0,right:20,bottom:80,left:80},_={top:0,right:0,bottom:0,left:80},S=960,T=800-M.top-M.bottom;function s(e,n){void 0!==diversityPlot.currentRequest&&0<Object.keys(diversityPlot.currentRequest).length&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={}),e.match("authent_by")&&(e=e.replace("/quickdiv.json","/diversity.json")),diversityPlot.currentRequest=d3.json(e,function(e,t){e?(alert("Error retrieving diversity data"),console.log(e)):function(n,a){for(var e,t,r=n[n.length-1].eag,i=n[0].lag,s=[{nam:"Neoproterozoic",lag:541,eag:1e3},{nam:"Paleozoic",lag:252.17,eag:541},{nam:"Mesozoic",lag:66,eag:252.17},{nam:"Cenozoic",lag:0,eag:66}],o=0;o<s.length;o++)r>=s[o].lag&&r<=s[o].eag&&(e=s[o].eag),i>=s[o].lag&&i<=s[o].eag&&(t=s[o].lag);$.ajax(paleo_nav.dataUrl+paleo_nav.dataService+"/intervals/list.json?scale=1&order=age.desc&max_ma="+e+"&min_ma="+t).fail(function(e){console.log(e)}).done(function(e){var t=e.records.filter(function(e){if(2===e.lvl||3===e.lvl)return e.totalTime=e.eag-e.lag,e});!function(e,t,n){var a=n?"#advdiversity":"#diversity";d3.select("#diversity","#advdiversity").select("svg").remove();var r=t.filter(function(e){if(3===e.lvl)return e}),i=t.filter(function(e){if(2===e.lvl)return e});if(n){e.map(function(e){.5<e.eag?e.origination=-Math.log(e.xbt/(e.xbt+e.xft))/(e.eag-e.lag):e.origination=NaN}),e.map(function(e){.5<e.eag?e.extinction=-Math.log(e.xbt/(e.xbt+e.xbl))/(e.eag-e.lag):e.origination=NaN}),e.map(function(e){e.rangethroughYes=e.xft+e.xbl+e.xfl+e.xbt,e.rangethroughNo=e.xbl+e.xfl+e.xbt});$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked")}var s=d3.scale.linear().domain([d3.max(i,function(e){return e.eag}),d3.min(i,function(e){return e.lag})-1]).range([0,S-M.left-M.right]);if(n)var o=d3.scale.linear().domain([0,d3.max(e,function(e){return e.rangethroughYes})]).range([T-M.top-M.bottom,0]),l=d3.scale.linear().domain([-1,1]).range([T-M.top-M.bottom,0]);else var o=d3.scale.linear().domain([0,d3.max(e,function(e){return e.total})]).range([T-M.top-M.bottom,0]);var c=d3.svg.axis().scale(s).orient("bottom").ticks(5),d=d3.svg.axis().scale(o).orient("left").ticks(5);if(n)var u=d3.svg.axis().scale(l).orient("right").tickValues([-1,0,1]).tickFormat(Math.abs);var p=d3.scale.linear().domain([0,d3.sum(t,function(e){if(2===e.lvl)return e.totalTime})]).range([0,S-M.left-M.right]),h=d3.scale.linear().domain([d3.max(t,function(e){return e.eag}),d3.min(t,function(e){return e.lag})]).range([0,S-M.left-M.right]),f=d3.select(a).append("svg").attr("width",S).attr("height",T).attr("id",n?"advdiversityGraph":"diversityGraph").append("g").attr("id",n?"advdiversityGraphGroup":"diversityGraphGroup").attr("transform","translate("+M.left+","+M.top+")").style("font-family","Helvetica,sans-serif").style("fill","#333").style("font-weight","100").style("font-size","0.8em"),m=d3.select(a+"Graph").select("g").append("g").attr("id","timeScale").attr("transform","translate("+_.left+","+(T-M.top-M.bottom+3)+")");m.selectAll(".periods").data(r).enter().append("rect").attr("height","40").attr("width",function(e){return p(e.totalTime)}).attr("x",function(e){return h(e.eag)}).attr("id",function(e){return"r"+e.oid.replace("int:","")}).style("fill",function(e){return e.col}).style("opacity",.83).append("svg:title").text(function(e){return e.nam}),m.selectAll(".periodNames").data(r).enter().append("text").attr("x",function(e){return(h(e.eag)+h(e.lag))/2}).attr("y","30").attr("id",function(e){return"l"+e.oid.replace("int:","")}).attr("class","timeLabel abbreviation").style("font-size","2.4em").text(function(e){return e.abr}),m.selectAll(".periodNames").data(r).enter().append("text").attr("x",function(e){return(h(e.eag)+h(e.lag))/2}).attr("y","30").attr("class","timeLabel dFullName").style("font-size","2.4em").attr("id",function(e){return"l"+e.oid.replace("int:","")}).text(function(e){return e.nam}),m.selectAll(".eras").data(i).enter().append("rect").attr("height","40").attr("width",function(e){return p(e.totalTime)}).attr("x",function(e){return h(e.eag)}).attr("y","40").attr("id",function(e){return"r"+e.oid.replace("int:","")}).style("fill",function(e){return e.col}).style("opacity",.83).append("svg:title").text(function(e){return e.nam}),m.selectAll(".eraNames").data(i).enter().append("text").attr("x",function(e){return(h(e.eag)+h(e.lag))/2}).attr("y","70").attr("class","timeLabel dFullName").style("font-size","2.4em").attr("id",function(e){return"l"+e.oid.replace("int:","")}).text(function(e){return e.nam}),f.append("g").attr("class","x axis").attr("transform","translate("+_.left+","+(T-M.top-M.bottom+85)+")").style("font-size","3em").style("fill","#777").call(c).select("path").style("display","none");var g=f.append("g").attr("class","y axis").attr("transform","translate("+_.left+",0)").style("fill","none").style("font-size","3em").style("letter-spacing","normal").call(d);if(g.append("text").attr("transform","rotate(-90)").attr("dy","1em").style("fill","#777").style("text-anchor","end").style("font-size","0.8em").style("font-weight",400).text($("[name=taxonLevel]").val()+" sampled in "+$("[name=timeLevel]").val()),g.append("text").attr("transform","rotate(-90)").attr("dy","3em").style("text-anchor","end").style("font-size","0.6em").style("font-weight",300).style("font-style","italics").style("fill","#777").text("(approximate)"),g.selectAll(".tick").style("letter-spacing","8px").style("fill","#777"),n){var v=f.append("g").attr("class","y axis").attr("transform","translate("+(S-20)+",0)").style("fill","none").style("font-size","3em").style("letter-spacing","normal").call(u);v.append("text").attr("transform","rotate(90)translate("+.28*T+",-35)").attr("dy","1em").style("fill","green").style("text-anchor","end").style("font-size","0.6em").style("font-weight",400).text("origination"),v.append("text").attr("transform","rotate(90)translate("+.7*T+",-35)").attr("dy","1em").style("fill","red").style("text-anchor","end").style("font-size","0.6em").style("font-weight",400).text("extinction"),v.append("text").attr("transform","rotate(90)translate("+.65*T+",-80)").attr("dy","1em").style("fill","#777").style("text-anchor","end").style("font-size","0.8em").style("font-weight",400).text("rates per "+$("[name=taxonLevel]").val()+" per Myr"),v.selectAll(".tick").style("letter-spacing","8px").style("fill","#777")}var y=d3.svg.line().interpolate("linear").x(function(e){return h(e.eag)}).y(function(e){return o(e.total)});if(f.append("path").datum(e).attr("class","line diversityLine sampledLine").attr("style","fill: none; stroke: #777; stroke-width: 4px;").attr("d",y).attr("transform","translate("+_.left+",0)"),n){C("sampledLine");var x=d3.svg.line().interpolate("linear").x(function(e){return h(e.eag)}).y(function(e){return o(e.rangethroughYes)});f.append("path").attr("class","line diversityLine rangethroughLineYes").attr("style","fill: none; stroke: black; stroke-width: 4px; stroke-dasharray: 4,2; display:none;").attr("d",x(e)).attr("transform","translate("+_.left+",0)");var b=d3.svg.line().interpolate("linear").x(function(e){return h(e.eag)}).y(function(e){return o(e.rangethroughNo)});f.append("path").attr("class","line diversityLine rangethroughLineNo").attr("style","fill: none; stroke: black; stroke-width: 4px; stroke-dasharray: 4,2; display:none;").attr("d",b(e)).attr("transform","translate("+_.left+",0)"),C("rangethroughLine");var w=d3.svg.line().interpolate("linear").defined(function(e){return!isNaN(e.origination)&isFinite(e.origination)}).x(function(e){return h(e.eag)}).y(function(e){return l(e.origination)});f.append("path").datum(e).attr("class","line diversityLine originationLine").attr("style","fill: none; stroke: green; stroke-width: 2px; display:none;").attr("d",w(e)).attr("transform","translate("+_.left+",0)"),C("originationLine");var k=d3.svg.line().interpolate("linear").defined(function(e){return!isNaN(e.extinction)&isFinite(e.extinction)}).x(function(e){return h(e.eag)}).y(function(e){return l(-e.extinction)});f.append("path").datum(e).attr("class","line diversityLine extinctionLine").attr("style","fill: none; stroke: red; stroke-width: 2px; display:none;").attr("d",k(e)).attr("transform","translate("+_.left+",0)"),C("extinctionLine")}F(!1,n),$("#diversityWait").css("display","none"),$("#advdiversityWait").css("display","none")}(n,t,a)})}(t.records.map(function(e){return e.total=e.dsb,e}),n)})}function F(e,t){var n=d3.selectAll(".dFullName");d3.selectAll(".dFullName").style("display","block"),d3.selectAll(".abbreviation").style("display","block");for(var a=0;a<n[0].length;a++){var r,i=d3.select(n[0][a]).data()[0].oid.replace("int:",""),s=parseFloat(d3.select("rect#r"+i).attr("width")),o=parseFloat(d3.select("rect#r"+i).attr("x"));try{r=d3.select(".dFullName#l"+i).node().getComputedTextLength()}catch(e){r=25}if(s-8<r){var l;d3.select(".dFullName#l"+i).style("display","none");try{l=d3.select(".abbreviation#l"+i).node().getComputedTextLength()}catch(e){l=10}s-8<l?d3.select(".abbreviation#l"+i).style("display","none"):d3.select(".abbreviation#l"+i).style("display","block").attr("x",o+(s-l)/2)}else d3.select(".abbreviation#l"+i).style("display","none"),d3.select(".dFullName#l"+i).attr("x",o+(s-r)/2)}e||setTimeout(function(){c(t)},100)}function c(e){var t=e?"adv":"";$("."+t+"statsContent").height("auto");var n,a=$("."+t+"diversityContainer").height()-50,r=$("."+t+"diversityContainer").width()-50;r<a?a<(n=r/S)*T&&(n=a/T):r<(n=a/T)*S&&(n=r/S);e?d3.select("#"+t+"diversityGraphGroup").attr("transform","scale("+n+")translate("+(M.left-80)+","+M.top+")"):d3.select("#"+t+"diversityGraphGroup").attr("transform","scale("+n+")translate("+M.left+","+M.top+")");var i=d3.select("#"+t+"diversityGraphGroup").node().getBBox().width;d3.select("#"+t+"diversityGraph").attr("height",a+M.bottom).attr("width",i*n+M.left),F(!0)}function C(e){var t=$("[name="+e+"]").is(":checked");if("rangethroughLine"===e){var n=$('[name="singletons"]').is(":checked")?["rangethroughLineYes","rangethroughLineNo"]:["rangethroughLineNo","rangethroughLineYes"];$("."+n[0]).css("display",t?"":"none"),$("."+n[1]).css("display","none")}else $("."+e).css("display",t?"":"none")}function o(e){var t=d3.select(e?"#advdiversityGraph":"#diversityGraph"),n=t.attr("height"),a=t.attr("width");d3.select("canvas").attr("height",n).attr("width",a)}return d3.select(window).on("resize",F),{plot:s,resize:c,currentRequest:void 0,updateQuickdiv:function(){var e=$("[name=taxonLevel]").val(),t=$("[name=timeLevel]").val(),n=paleo_nav.dataUrl;$("#advtaxonLevel").html(e),$("#advtimeLevel").html(t);var a=map.getBounds(),r=a._southWest,i=a._northEast;parseInt(d3.select("#map").style("height"))<1&&(r.lng=-180,i.lng=180,r.lat=-90,i.lat=90),n+=paleo_nav.dataService+"/occs/quickdiv.json?",n=navMap.parseURL(n),n+="&lngmin="+r.lng.toFixed(1)+"&lngmax="+i.lng.toFixed(1)+"&latmin="+r.lat.toFixed(1)+"&latmax="+i.lat.toFixed(1),s(n+="&count="+e+"&time_reso="+t)},saveImg:function(a){var e=d3.select(a?"#advdiversityGraph":"#diversityGraph").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,t="data:image/svg+xml;base64,"+btoa(e),n='<img src="'+t+'">';d3.select(a?"#advsvgdataurl":"#svgdataurl").html(n),o(a);var r=document.querySelector("canvas"),i=r.getContext("2d"),s=new Image;s.src=t,s.onload=function(){i.drawImage(s,0,0);var e=r.toDataURL("image/png"),t='<img src="'+e+'">';d3.select(a?"#advpngdataurl":"#pngdataurl").html(t);var n=document.createElement("a");n.download="diversity-curve.png",n.href=e,n.id="downloadLink",document.getElementsByTagName("body")[0].appendChild(n),n.click()}},getCanvasSize:o,toggleLine:C}}();
//# sourceMappingURL=script.min.js.map